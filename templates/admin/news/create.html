{% extends "admin/base.html" %}

{% block title %}Tạo tin tức mới - Admin{% endblock %}
{% block page_title %}Tạo tin tức mới{% endblock %}
{% block page_description %}Thêm bài viết tin tức mới{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <form method="POST" enctype="multipart/form-data" class="space-y-6">
        <div class="admin-card p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-6">Thông tin cơ bản</h2>
            
            <div class="grid grid-cols-1 gap-6">
                <div>
                    <label for="title" class="block text-sm font-medium text-gray-700 mb-2">
                        Tiêu đề <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="title" name="title" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                           placeholder="Nhập tiêu đề tin tức">
                </div>
                
                <div>
                    <label for="summary" class="block text-sm font-medium text-gray-700 mb-2">
                        Tóm tắt
                    </label>
                    <textarea id="summary" name="summary" rows="3"
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                              placeholder="Tóm tắt ngắn gọn về nội dung tin tức"></textarea>
                </div>
                
                <div>
                    <label for="content" class="block text-sm font-medium text-gray-700 mb-2">
                        Nội dung <span class="text-red-500">*</span>
                    </label>
                    <textarea id="content" name="content" rows="10" required
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                              placeholder="Nhập nội dung đầy đủ của tin tức..."></textarea>
                </div>
            </div>
        </div>
        
        <div class="admin-card p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-6">Hình ảnh đại diện</h2>
            
            <div class="space-y-4">
                <div>
                    <label for="featured_image" class="block text-sm font-medium text-gray-700 mb-2">
                        Chọn hình ảnh
                    </label>
                    <div class="flex items-center justify-center w-full">
                        <label for="featured_image" class="flex flex-col items-center justify-center w-full h-64 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                            <div class="flex flex-col items-center justify-center pt-5 pb-6" id="upload-placeholder">
                                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                                <p class="mb-2 text-sm text-gray-500">
                                    <span class="font-semibold">Nhấp để tải lên</span> hoặc kéo thả
                                </p>
                                <p class="text-xs text-gray-500">PNG, JPG, JPEG (MAX. 16MB)</p>
                            </div>
                            <input id="featured_image" name="featured_image" type="file" class="hidden" 
                                   accept="image/*" onchange="initImageCropper(this, 'image-preview')">
                        </label>
                    </div>
                </div>
                
                <!-- Image Preview and Cropper -->
                <div id="image-cropper-container" class="hidden">
                    <div class="border border-gray-300 rounded-lg p-4 bg-white">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-medium text-gray-900">Chỉnh sửa hình ảnh</h3>
                            <div class="flex space-x-2">
                                <button type="button" onclick="resetCropper()" 
                                        class="px-3 py-1 bg-gray-500 text-white rounded text-sm hover:bg-gray-600">
                                    <i class="fas fa-undo mr-1"></i>Đặt lại
                                </button>
                                <button type="button" onclick="applyCrop()" 
                                        class="px-3 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600">
                                    <i class="fas fa-check mr-1"></i>Áp dụng
                                </button>
                            </div>
                        </div>
                        <div class="max-w-full max-h-96 overflow-hidden">
                            <img id="image-preview" class="max-w-full hidden" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="admin-card p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-6">Cài đặt xuất bản</h2>
            
            <div class="flex items-center">
                <input id="is_published" name="is_published" type="checkbox" checked
                       class="h-4 w-4 text-orange-600 focus:ring-orange-500 border-gray-300 rounded">
                <label for="is_published" class="ml-2 block text-sm text-gray-900">
                    Hiển thị công khai trên website
                </label>
            </div>
        </div>
        
        <div class="flex items-center justify-between pt-6">
            <a href="{{ url_for('admin_news') }}" 
               class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition duration-200">
                <i class="fas fa-arrow-left mr-2"></i>Quay lại
            </a>
            
            <div class="flex space-x-4">
                <button type="submit" name="action" value="draft"
                        class="px-6 py-3 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition duration-200">
                    <i class="fas fa-save mr-2"></i>Lưu nháp
                </button>
                <button type="submit" name="action" value="publish"
                        class="btn-primary px-6 py-3 rounded-lg hover:bg-orange-600 transition duration-200">
                    <i class="fas fa-paper-plane mr-2"></i>Đăng ngay
                </button>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
    <script src="https://cdn.jsdelivr.net/npm/tinymce@6/tinymce.min.js" referrerpolicy="origin"></script>
    <script src="{{ url_for('static', filename='js/external-image-picker.js') }}"></script>
<script>
    // Initialize TinyMCE editor with image upload
    tinymce.init({
        selector: '#content',
        height: 500,
        plugins: [
            'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
            'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
            'insertdatetime', 'media', 'table', 'help', 'wordcount', 'emoticons'
        ],
        toolbar: 'undo redo | blocks | bold italic forecolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | image media link | table | emoticons | fullscreen | help',
        menubar: 'file edit view insert format tools table help',
        
        // Image upload configuration
        images_upload_url: '{{ url_for("admin_upload_image") }}',
        images_upload_base_path: '',
        images_upload_credentials: true,
        automatic_uploads: true,
        
        // File picker for images
        file_picker_types: 'image',
        file_picker_callback: function(callback, value, meta) {
            if (meta.filetype === 'image') {
                // Hiển thị dialog cho phép chọn upload file hoặc URL
                const choice = confirm('Chọn "OK" để upload file từ máy tính\nChọn "Cancel" để sử dụng URL hình ảnh từ internet');
                
                if (choice) {
                    // Upload file từ máy tính
                    var input = document.createElement('input');
                    input.setAttribute('type', 'file');
                    input.setAttribute('accept', 'image/*');
                    
                    input.onchange = function() {
                        var file = this.files[0];
                        var formData = new FormData();
                        formData.append('file', file);
                        
                        fetch('{{ url_for("admin_upload_image") }}', {
                            method: 'POST',
                            body: formData,
                            credentials: 'same-origin'
                        })
                        .then(response => response.json())
                        .then(result => {
                            if (result.location) {
                                callback(result.location, {
                                    alt: file.name,
                                    title: file.name
                                });
                            } else {
                                alert('Upload failed: ' + (result.error || 'Unknown error'));
                            }
                        })
                        .catch(error => {
                            console.error('Upload error:', error);
                            alert('Upload failed: ' + error.message);
                        });
                    };
                    
                    input.click();
                } else {
                    // Sử dụng URL hình ảnh từ bên ngoài
                    if (window.ExternalImagePicker) {
                        const picker = new ExternalImagePicker(callback);
                        picker.showModal();
                    } else {
                        // Fallback - simple prompt
                        const url = prompt('Nhập URL hình ảnh:');
                        if (url) {
                            fetch('{{ url_for("admin_process_external_image") }}', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ url: url })
                            })
                            .then(response => response.json())
                            .then(result => {
                                if (result.location) {
                                    callback(result.location, {
                                        alt: 'External image',
                                        title: 'External image'
                                    });
                                } else {
                                    alert('URL processing failed: ' + (result.error || 'Unknown error'));
                                }
                            })
                            .catch(error => {
                                console.error('URL processing error:', error);
                                alert('URL processing failed: ' + error.message);
                            });
                        }
                    }
                }
            }
        },
        
        // Content styling
        content_style: `
            body { 
                font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
                font-size: 14px; 
                line-height: 1.6;
                color: #374151;
                max-width: none;
            }
            img {
                max-width: 100%;
                height: auto;
                border-radius: 8px;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                margin: 10px 0;
            }
            h1, h2, h3, h4, h5, h6 {
                color: #1f2937;
                margin-top: 1.5em;
                margin-bottom: 0.5em;
            }
            p {
                margin-bottom: 1em;
            }
            ul, ol {
                margin-bottom: 1em;
                padding-left: 1.5em;
            }
            blockquote {
                border-left: 4px solid #f59e0b;
                padding-left: 1em;
                margin: 1em 0;
                font-style: italic;
                background-color: #fef3c7;
                padding: 1em;
                border-radius: 4px;
            }
        `,
        
        // Language
        language: 'vi',
        
        // Other settings
        menubar: true,
        branding: false,
        resize: true,
        elementpath: false,
        statusbar: true,
        
        // Paste settings
        paste_as_text: false,
        paste_auto_cleanup_on_paste: true,
        
        // Setup callback
        setup: function(editor) {
            editor.on('change', function() {
                editor.save();
            });
        }
    });
    
    // Image cropper functionality
    function resetCropper() {
        document.getElementById('featured_image').value = '';
        document.getElementById('image-cropper-container').classList.add('hidden');
        document.getElementById('upload-placeholder').classList.remove('hidden');
        if (window.cropper) {
            window.cropper.destroy();
            window.cropper = null;
        }
    }
    
    function applyCrop() {
        if (window.cropper) {
            const canvas = window.cropper.getCroppedCanvas({
                imageSmoothingEnabled: true,
                imageSmoothingQuality: 'high'
            });
            
            canvas.toBlob(function(blob) {
                // Create a new File object from the blob
                const file = new File([blob], 'cropped-image.jpg', { type: 'image/jpeg' });
                
                // Update the file input (this is a simplified approach)
                console.log('Image cropped successfully');
                alert('Hình ảnh đã được cắt thành công!');
            }, 'image/jpeg', 0.9);
        }
    }
    
    // Override the global initImageCropper function
    function initImageCropper(input, previewId) {
        if (window.cropper) {
            window.cropper.destroy();
            window.cropper = null;
        }
        
        const file = input.files[0];
        if (file) {
            const preview = document.getElementById(previewId);
            const reader = new FileReader();
            
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.classList.remove('hidden');
                document.getElementById('image-cropper-container').classList.remove('hidden');
                document.getElementById('upload-placeholder').classList.add('hidden');
                
                window.cropper = new Cropper(preview, {
                    aspectRatio: 16/9,
                    viewMode: 2,
                    autoCropArea: 0.8,
                    responsive: true,
                    background: false,
                    guides: true,
                    center: true,
                    highlight: false,
                    cropBoxMovable: true,
                    cropBoxResizable: true,
                    toggleDragModeOnDblclick: false
                });
            };
            
            reader.readAsDataURL(file);
        }
    }
    
    // Form validation
    document.querySelector('form').addEventListener('submit', function(e) {
        const title = document.getElementById('title').value.trim();
        const content = tinymce.get('content').getContent().trim();
        
        if (!title || !content) {
            e.preventDefault();
            alert('Vui lòng điền đầy đủ tiêu đề và nội dung!');
            return false;
        }
    });
</script>
{% endblock %}