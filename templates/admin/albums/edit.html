{% extends "admin/base.html" %}

{% block title %}Chỉnh sửa Album - {{ album.title }} - Admin{% endblock %}
{% block page_title %}Chỉnh sửa Album{% endblock %}
{% block page_description %}Cập nhật thông tin và quản lý ảnh trong album{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <form method="POST" enctype="multipart/form-data" class="space-y-6">
        <!-- Album Info -->
        <div class="admin-card p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-6">Thông tin album</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="title" class="block text-sm font-medium text-gray-700 mb-2">
                        Tiêu đề album <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="title" name="title" required
                           value="{{ album.title }}"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                           placeholder="Ví dụ: Hoạt động học tập tháng 10">
                </div>
                
                <div>
                    <label for="category" class="block text-sm font-medium text-gray-700 mb-2">
                        Danh mục
                    </label>
                    <select id="category" name="category"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                        <option value="">Chọn danh mục</option>
                        <option value="Hoạt động học tập" {{ 'selected' if album.category == 'Hoạt động học tập' }}>Hoạt động học tập</option>
                        <option value="Vui chơi giải trí" {{ 'selected' if album.category == 'Vui chơi giải trí' }}>Vui chơi giải trí</option>
                        <option value="Sự kiện đặc biệt" {{ 'selected' if album.category == 'Sự kiện đặc biệt' }}>Sự kiện đặc biệt</option>
                        <option value="Cơ sở vật chất" {{ 'selected' if album.category == 'Cơ sở vật chất' }}>Cơ sở vật chất</option>
                        <option value="Đội ngũ giáo viên" {{ 'selected' if album.category == 'Đội ngũ giáo viên' }}>Đội ngũ giáo viên</option>
                        <option value="Khác" {{ 'selected' if album.category == 'Khác' }}>Khác</option>
                    </select>
                </div>
                
                <div class="md:col-span-2">
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
                        Mô tả
                    </label>
                    <textarea id="description" name="description" rows="3"
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                              placeholder="Mô tả ngắn gọn về album này">{{ album.description or '' }}</textarea>
                </div>
                
                <div class="md:col-span-2">
                    <div class="flex items-center">
                        <input id="is_featured" name="is_featured" type="checkbox" {{ 'checked' if album.is_featured }}
                               class="h-4 w-4 text-orange-600 focus:ring-orange-500 border-gray-300 rounded">
                        <label for="is_featured" class="ml-2 block text-sm text-gray-900">
                            Hiển thị nổi bật trên trang chủ
                        </label>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Add New Images -->
        <div class="admin-card p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-6">
                <i class="fas fa-plus text-green-500 mr-2"></i>
                Thêm ảnh mới vào album
            </h2>
            
            <div class="space-y-6">
                <div>
                    <label for="new_images" class="block text-sm font-medium text-gray-700 mb-2">
                        Chọn ảnh mới <span class="text-gray-500">(Ctrl/Cmd + Click để chọn nhiều)</span>
                    </label>
                    <div class="flex items-center justify-center w-full">
                        <label for="new_images" class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                            <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                                <p class="text-sm text-gray-500">
                                    <span class="font-semibold">Nhấp để tải lên</span> hoặc kéo thả ảnh
                                </p>
                                <p class="text-xs text-gray-500">PNG, JPG, JPEG (MAX. 16MB mỗi file)</p>
                            </div>
                            <input id="new_images" name="new_images" type="file" class="hidden" 
                                   accept="image/*" multiple>
                        </label>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Current Images with Drag & Drop Sorting -->
        {% if album.images %}
        <div class="admin-card p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-6">
                <i class="fas fa-images text-blue-500 mr-2"></i>
                Ảnh hiện tại trong album ({{ album.images|length }} ảnh)
            </h2>
            
            <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <div class="flex items-center">
                    <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                    <p class="text-sm text-blue-700">
                        <strong>Hướng dẫn:</strong> Kéo và thả ảnh để thay đổi thứ tự hiển thị. Thứ tự sẽ được lưu tự động.
                    </p>
                </div>
            </div>
            
            <div id="sortable-images" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                {% for image in album.images %}
                <div class="sortable-item relative group bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden cursor-move hover:shadow-md transition-all duration-200" 
                     data-image-id="{{ image.id }}">
                    <!-- Drag Handle -->
                    <div class="absolute top-2 left-2 z-10 bg-black/50 text-white p-1 rounded opacity-0 group-hover:opacity-100 transition-opacity">
                        <i class="fas fa-grip-vertical text-xs"></i>
                    </div>
                    
                    <!-- Cover Badge -->
                    {% if album.cover_image_id == image.id %}
                    <div class="absolute top-2 right-2 z-10 bg-yellow-500 text-white px-2 py-1 rounded-full text-xs font-medium">
                        <i class="fas fa-star mr-1"></i>Bìa
                    </div>
                    {% endif %}
                    
                    <!-- Image -->
                    <div class="aspect-square overflow-hidden">
                        {% if image.image_path.startswith('http') %}
                        <img src="{{ image.image_path }}" 
                             alt="{{ image.title or album.title }}" 
                             class="w-full h-full object-cover">
                        {% else %}
                        <img src="/static/{{ image.image_path }}" 
                             alt="{{ image.title or album.title }}" 
                             class="w-full h-full object-cover">
                        {% endif %}
                    </div>
                    
                    <!-- Actions -->
                    <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity duration-200 flex items-center justify-center">
                        <div class="flex space-x-2">
                            {% if album.cover_image_id != image.id %}
                            <form method="POST" action="{{ url_for('admin_album_set_cover', album_id=album.id, image_id=image.id) }}" class="inline">
                                <button type="submit" class="bg-yellow-500 text-white p-2 rounded-full hover:bg-yellow-600 transition-colors" title="Đặt làm ảnh bìa">
                                    <i class="fas fa-star text-xs"></i>
                                </button>
                            </form>
                            {% endif %}
                            
                            <form method="POST" action="{{ url_for('admin_album_remove_image', album_id=album.id, image_id=image.id) }}" class="inline">
                                <button type="button" class="remove-image-btn bg-red-500 text-white p-2 rounded-full hover:bg-red-600 transition-colors" title="Xóa ảnh">
                                    <i class="fas fa-trash text-xs"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Image Info -->
                    <div class="p-2">
                        <p class="text-xs text-gray-600 truncate" title="{{ image.title or 'Không có tiêu đề' }}">
                            {{ image.title or 'Không có tiêu đề' }}
                        </p>
                        <p class="text-xs text-gray-400">ID: {{ image.id }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Sort Status -->
            <div id="sort-status" class="mt-4 p-3 rounded-lg hidden">
                <div class="flex items-center justify-center">
                    <i class="fas fa-spinner fa-spin mr-2"></i>
                    <span class="text-sm">Đang cập nhật thứ tự...</span>
                </div>
            </div>
        </div>
        {% endif %}
        
        <div class="flex items-center justify-between pt-6">
            <a href="{{ url_for('admin_album_detail', id=album.id) }}" 
               class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition duration-200">
                <i class="fas fa-arrow-left mr-2"></i>Quay lại
            </a>
            
            <div class="flex space-x-4">
                <form method="POST" action="{{ url_for('admin_album_delete', id=album.id) }}" class="inline">
                    <button type="button" 
                            class="delete-album-btn px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-200">
                        <i class="fas fa-trash mr-2"></i>Xóa Album
                    </button>
                </form>
                
                <button type="submit"
                        class="btn-primary px-6 py-3 rounded-lg hover:bg-orange-600 transition duration-200">
                    <i class="fas fa-save mr-2"></i>Lưu thay đổi
                </button>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<!-- SortableJS CDN for drag & drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
    // Xác nhận xóa album
    document.addEventListener('click', function(e) {
        if (e.target.closest('.delete-album-btn')) {
            e.preventDefault();
            if (confirm('Bạn có chắc chắn muốn xóa album này không?\n\nTất cả ảnh trong album sẽ bị xóa vĩnh viễn. Hành động này không thể hoàn tác.')) {
                e.target.closest('form').submit();
            }
        }
        
        // Xác nhận xóa ảnh
        if (e.target.closest('.remove-image-btn')) {
            e.preventDefault();
            if (confirm('Bạn có chắc chắn muốn xóa ảnh này khỏi album không?\n\nHành động này không thể hoàn tác.')) {
                e.target.closest('form').submit();
            }
        }
    });
    
    // Preview new images
    document.getElementById('new_images').addEventListener('change', function(e) {
        const files = e.target.files;
        if (files.length > 0) {
            const fileNames = Array.from(files).map(f => f.name).join(', ');
            const label = e.target.closest('label');
            const originalContent = label.innerHTML;
            
            label.innerHTML = `
                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                    <i class="fas fa-check-circle text-3xl text-green-500 mb-2"></i>
                    <p class="text-sm text-green-600 font-semibold">
                        Đã chọn ${files.length} ảnh
                    </p>
                    <p class="text-xs text-gray-500 mt-1 text-center px-4">
                        ${fileNames.length > 100 ? fileNames.substring(0, 100) + '...' : fileNames}
                    </p>
                    <p class="text-xs text-blue-500 mt-2">Nhấp để chọn ảnh khác</p>
                </div>
            `;
        }
    });
    
    // Initialize Drag & Drop Sorting
    document.addEventListener('DOMContentLoaded', function() {
        const sortableContainer = document.getElementById('sortable-images');
        if (sortableContainer) {
            const sortable = new Sortable(sortableContainer, {
                animation: 200,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                dragClass: 'sortable-drag',
                handle: '.sortable-item', // Entire item is draggable
                onStart: function(evt) {
                    // Add visual feedback when dragging starts
                    evt.item.style.opacity = '0.5';
                },
                onEnd: function(evt) {
                    // Remove visual feedback
                    evt.item.style.opacity = '1';
                    
                    // Get new order of image IDs
                    const imageIds = Array.from(sortableContainer.children).map(item => 
                        parseInt(item.getAttribute('data-image-id'))
                    );
                    
                    // Show loading status
                    showSortStatus('loading');
                    
                    // Send AJAX request to update sort order
                    fetch(`/admin/albums/{{ album.id }}/update-sort-order`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({
                            image_ids: imageIds
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showSortStatus('success', data.message);
                        } else {
                            showSortStatus('error', data.message || 'Có lỗi xảy ra');
                            // Revert the change if failed
                            location.reload();
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showSortStatus('error', 'Không thể cập nhật thứ tự ảnh');
                        // Revert the change if failed
                        location.reload();
                    });
                }
            });
        }
    });
    
    // Show sort status message
    function showSortStatus(type, message = '') {
        const statusDiv = document.getElementById('sort-status');
        if (!statusDiv) return;
        
        statusDiv.classList.remove('hidden');
        
        if (type === 'loading') {
            statusDiv.className = 'mt-4 p-3 rounded-lg bg-blue-50 border border-blue-200';
            statusDiv.innerHTML = `
                <div class="flex items-center justify-center">
                    <i class="fas fa-spinner fa-spin mr-2 text-blue-500"></i>
                    <span class="text-sm text-blue-700">Đang cập nhật thứ tự...</span>
                </div>
            `;
        } else if (type === 'success') {
            statusDiv.className = 'mt-4 p-3 rounded-lg bg-green-50 border border-green-200';
            statusDiv.innerHTML = `
                <div class="flex items-center justify-center">
                    <i class="fas fa-check-circle mr-2 text-green-500"></i>
                    <span class="text-sm text-green-700">${message}</span>
                </div>
            `;
            // Hide after 3 seconds
            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 3000);
        } else if (type === 'error') {
            statusDiv.className = 'mt-4 p-3 rounded-lg bg-red-50 border border-red-200';
            statusDiv.innerHTML = `
                <div class="flex items-center justify-center">
                    <i class="fas fa-exclamation-circle mr-2 text-red-500"></i>
                    <span class="text-sm text-red-700">${message}</span>
                </div>
            `;
            // Hide after 5 seconds
            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 5000);
        }
    }
</script>

<style>
    /* Sortable styles */
    .sortable-ghost {
        opacity: 0.4;
        transform: rotate(5deg);
    }
    
    .sortable-chosen {
        transform: scale(1.05);
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    
    .sortable-drag {
        transform: rotate(5deg);
        opacity: 0.8;
    }
    
    .sortable-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
</style>
{% endblock %}
