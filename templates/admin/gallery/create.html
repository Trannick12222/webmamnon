{% extends "admin/base.html" %}

{% block title %}Thêm hình ảnh - Admin{% endblock %}
{% block page_title %}Thêm hình ảnh{% endblock %}
{% block page_description %}Upload và quản lý hình ảnh cho thư viện{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <form method="POST" enctype="multipart/form-data" class="space-y-6">
        <div class="admin-card p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-6">Thông tin chung</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="title" class="block text-sm font-medium text-gray-700 mb-2">
                        Tiêu đề bộ sưu tập
                    </label>
                    <input type="text" id="title" name="title"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                           placeholder="Ví dụ: Hoạt động học tập tháng 10">
                </div>
                
                <div>
                    <label for="category" class="block text-sm font-medium text-gray-700 mb-2">
                        Danh mục
                    </label>
                    <select id="category" name="category"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                        <option value="">Chọn danh mục</option>
                        <option value="Hoạt động học tập">Hoạt động học tập</option>
                        <option value="Vui chơi giải trí">Vui chơi giải trí</option>
                        <option value="Sự kiện đặc biệt">Sự kiện đặc biệt</option>
                        <option value="Cơ sở vật chất">Cơ sở vật chất</option>
                        <option value="Đội ngũ giáo viên">Đội ngũ giáo viên</option>
                        <option value="Khác">Khác</option>
                    </select>
                </div>
                
                <div class="md:col-span-2">
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
                        Mô tả
                    </label>
                    <textarea id="description" name="description" rows="3"
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                              placeholder="Mô tả ngắn gọn về bộ sưu tập hình ảnh này"></textarea>
                </div>
                
                <div class="md:col-span-2">
                    <div class="flex items-center">
                        <input id="is_featured" name="is_featured" type="checkbox"
                               class="h-4 w-4 text-orange-600 focus:ring-orange-500 border-gray-300 rounded">
                        <label for="is_featured" class="ml-2 block text-sm text-gray-900">
                            Hiển thị nổi bật trên trang chủ
                        </label>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="admin-card p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-6">
                <i class="fas fa-images text-orange-500 mr-2"></i>
                Tải lên hình ảnh
            </h2>
            
            <div class="space-y-6">
                <!-- Multiple Image Upload -->
                <div>
                    <label for="images" class="block text-sm font-medium text-gray-700 mb-2">
                        Chọn nhiều hình ảnh <span class="text-gray-500">(Ctrl/Cmd + Click để chọn nhiều)</span>
                    </label>
                    <div class="flex items-center justify-center w-full">
                        <label for="images" class="flex flex-col items-center justify-center w-full h-64 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                            <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                                <p class="mb-2 text-sm text-gray-500">
                                    <span class="font-semibold">Nhấp để tải lên</span> hoặc kéo thả nhiều hình ảnh
                                </p>
                                <p class="text-xs text-gray-500">PNG, JPG, JPEG (MAX. 16MB mỗi file)</p>
                            </div>
                            <input id="images" name="images" type="file" class="hidden" 
                                   accept="image/*" multiple onchange="handleMultipleImages(this)">
                        </label>
                    </div>
                </div>
                
                <!-- Image Preview Grid -->
                <div id="image-preview-grid" class="hidden">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Xem trước hình ảnh</h3>
                    <div id="preview-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <!-- Preview images will be dynamically added here -->
                    </div>
                    
                    <!-- Bulk Actions -->
                    <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                        <h4 class="text-md font-medium text-gray-800 mb-3">Thao tác hàng loạt</h4>
                        <div class="flex flex-wrap items-center gap-4">
                            <button type="button" onclick="selectAllImages()" 
                                    class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 text-sm">
                                <i class="fas fa-check-square mr-1"></i>Chọn tất cả
                            </button>
                            <button type="button" onclick="deselectAllImages()" 
                                    class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 text-sm">
                                <i class="fas fa-square mr-1"></i>Bỏ chọn tất cả
                            </button>
                            <button type="button" onclick="removeSelectedImages()" 
                                    class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 text-sm">
                                <i class="fas fa-trash mr-1"></i>Xóa đã chọn
                            </button>
                            <button type="button" onclick="cropSelectedImages()" 
                                    class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 text-sm">
                                <i class="fas fa-crop mr-1"></i>Cắt hình đã chọn
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Image Cropper Modal -->
        <div id="cropper-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-lg max-w-4xl w-full max-h-screen overflow-auto">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">Chỉnh sửa hình ảnh</h3>
                            <button type="button" onclick="closeCropperModal()" 
                                    class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        
                        <div class="mb-4">
                            <div class="flex items-center space-x-4 mb-4">
                                <label class="flex items-center">
                                    <input type="radio" name="aspect_ratio" value="16:9" checked class="mr-2">
                                    <span class="text-sm">16:9 (Ngang)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="aspect_ratio" value="4:3" class="mr-2">
                                    <span class="text-sm">4:3 (Ngang)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="aspect_ratio" value="1:1" class="mr-2">
                                    <span class="text-sm">1:1 (Vuông)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="aspect_ratio" value="free" class="mr-2">
                                    <span class="text-sm">Tự do</span>
                                </label>
                            </div>
                            
                            <div class="max-h-96 overflow-hidden">
                                <img id="crop-image" class="max-w-full" />
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <div class="flex space-x-2">
                                <button type="button" onclick="rotateCropImage(-90)" 
                                        class="px-3 py-2 bg-gray-500 text-white rounded text-sm hover:bg-gray-600">
                                    <i class="fas fa-undo mr-1"></i>Xoay trái
                                </button>
                                <button type="button" onclick="rotateCropImage(90)" 
                                        class="px-3 py-2 bg-gray-500 text-white rounded text-sm hover:bg-gray-600">
                                    <i class="fas fa-redo mr-1"></i>Xoay phải
                                </button>
                                <button type="button" onclick="resetCropImage()" 
                                        class="px-3 py-2 bg-yellow-500 text-white rounded text-sm hover:bg-yellow-600">
                                    <i class="fas fa-refresh mr-1"></i>Đặt lại
                                </button>
                            </div>
                            
                            <div class="flex space-x-2">
                                <button type="button" onclick="closeCropperModal()" 
                                        class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                                    Hủy
                                </button>
                                <button type="button" onclick="applyCropToImage()" 
                                        class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                                    <i class="fas fa-check mr-1"></i>Áp dụng
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="flex items-center justify-between pt-6">
            <a href="{{ url_for('admin_gallery') }}" 
               class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition duration-200">
                <i class="fas fa-arrow-left mr-2"></i>Quay lại
            </a>
            
            <button type="submit"
                    class="btn-primary px-6 py-3 rounded-lg hover:bg-orange-600 transition duration-200">
                <i class="fas fa-upload mr-2"></i>Tải lên hình ảnh
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let selectedImages = [];
    let currentCropperInstance = null;
    let currentImageIndex = -1;
    
    function handleMultipleImages(input) {
        const files = Array.from(input.files);
        selectedImages = [];
        
        if (files.length > 0) {
            document.getElementById('image-preview-grid').classList.remove('hidden');
            const container = document.getElementById('preview-container');
            container.innerHTML = '';
            
            files.forEach((file, index) => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        createImagePreview(e.target.result, file.name, index);
                        selectedImages.push({
                            file: file,
                            src: e.target.result,
                            name: file.name,
                            cropped: false
                        });
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
    }
    
    function createImagePreview(src, name, index) {
        const container = document.getElementById('preview-container');
        const previewDiv = document.createElement('div');
        previewDiv.className = 'relative group bg-white border border-gray-200 rounded-lg overflow-hidden';
        previewDiv.innerHTML = `
            <div class="aspect-w-16 aspect-h-9">
                <img src="${src}" alt="${name}" class="w-full h-32 object-cover">
            </div>
            <div class="p-3">
                <p class="text-xs text-gray-600 truncate" title="${name}">${name}</p>
                <div class="flex items-center justify-between mt-2">
                    <label class="flex items-center">
                        <input type="checkbox" class="image-checkbox mr-2" data-index="${index}">
                        <span class="text-xs text-gray-500">Chọn</span>
                    </label>
                    <button type="button" onclick="cropSingleImage(${index})" 
                            class="text-xs bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600">
                        <i class="fas fa-crop mr-1"></i>Cắt
                    </button>
                </div>
            </div>
            <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                <button type="button" onclick="removeImage(${index})" 
                        class="bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-600">
                    <i class="fas fa-times text-xs"></i>
                </button>
            </div>
        `;
        container.appendChild(previewDiv);
    }
    
    function selectAllImages() {
        document.querySelectorAll('.image-checkbox').forEach(checkbox => {
            checkbox.checked = true;
        });
    }
    
    function deselectAllImages() {
        document.querySelectorAll('.image-checkbox').forEach(checkbox => {
            checkbox.checked = false;
        });
    }
    
    function removeSelectedImages() {
        const checkboxes = document.querySelectorAll('.image-checkbox:checked');
        if (checkboxes.length === 0) {
            alert('Vui lòng chọn ít nhất một hình ảnh để xóa!');
            return;
        }
        
        if (confirm(`Bạn có chắc chắn muốn xóa ${checkboxes.length} hình ảnh đã chọn?`)) {
            const indicesToRemove = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index));
            indicesToRemove.sort((a, b) => b - a); // Sort in descending order
            
            indicesToRemove.forEach(index => {
                removeImage(index);
            });
        }
    }
    
    function removeImage(index) {
        selectedImages.splice(index, 1);
        refreshImagePreviews();
    }
    
    function refreshImagePreviews() {
        const container = document.getElementById('preview-container');
        container.innerHTML = '';
        
        selectedImages.forEach((imageData, index) => {
            createImagePreview(imageData.src, imageData.name, index);
        });
        
        if (selectedImages.length === 0) {
            document.getElementById('image-preview-grid').classList.add('hidden');
            document.getElementById('images').value = '';
        }
    }
    
    function cropSingleImage(index) {
        currentImageIndex = index;
        const imageData = selectedImages[index];
        showCropperModal(imageData.src);
    }
    
    function cropSelectedImages() {
        const checkboxes = document.querySelectorAll('.image-checkbox:checked');
        if (checkboxes.length === 0) {
            alert('Vui lòng chọn ít nhất một hình ảnh để cắt!');
            return;
        }
        
        // For now, crop the first selected image
        const firstSelectedIndex = parseInt(checkboxes[0].dataset.index);
        cropSingleImage(firstSelectedIndex);
    }
    
    function showCropperModal(imageSrc) {
        document.getElementById('cropper-modal').classList.remove('hidden');
        const cropImage = document.getElementById('crop-image');
        cropImage.src = imageSrc;
        
        // Wait for image to load before initializing cropper
        cropImage.onload = function() {
            if (currentCropperInstance) {
                currentCropperInstance.destroy();
            }
            
            currentCropperInstance = new Cropper(cropImage, {
                aspectRatio: 16/9,
                viewMode: 2,
                autoCropArea: 0.8,
                responsive: true,
                background: false,
                guides: true,
                center: true,
                highlight: false,
                cropBoxMovable: true,
                cropBoxResizable: true,
                toggleDragModeOnDblclick: false
            });
        };
    }
    
    function closeCropperModal() {
        document.getElementById('cropper-modal').classList.add('hidden');
        if (currentCropperInstance) {
            currentCropperInstance.destroy();
            currentCropperInstance = null;
        }
        currentImageIndex = -1;
    }
    
    function rotateCropImage(degrees) {
        if (currentCropperInstance) {
            currentCropperInstance.rotate(degrees);
        }
    }
    
    function resetCropImage() {
        if (currentCropperInstance) {
            currentCropperInstance.reset();
        }
    }
    
    function applyCropToImage() {
        if (currentCropperInstance && currentImageIndex >= 0) {
            const canvas = currentCropperInstance.getCroppedCanvas({
                imageSmoothingEnabled: true,
                imageSmoothingQuality: 'high'
            });
            
            canvas.toBlob(function(blob) {
                // Update the image data
                const reader = new FileReader();
                reader.onload = function(e) {
                    selectedImages[currentImageIndex].src = e.target.result;
                    selectedImages[currentImageIndex].cropped = true;
                    selectedImages[currentImageIndex].file = new File([blob], 
                        selectedImages[currentImageIndex].name, 
                        { type: 'image/jpeg' });
                    
                    refreshImagePreviews();
                    closeCropperModal();
                };
                reader.readAsDataURL(blob);
            }, 'image/jpeg', 0.9);
        }
    }
    
    // Aspect ratio change handler
    document.addEventListener('change', function(e) {
        if (e.target.name === 'aspect_ratio' && currentCropperInstance) {
            const value = e.target.value;
            let aspectRatio;
            
            switch(value) {
                case '16:9': aspectRatio = 16/9; break;
                case '4:3': aspectRatio = 4/3; break;
                case '1:1': aspectRatio = 1; break;
                case 'free': aspectRatio = NaN; break;
                default: aspectRatio = 16/9;
            }
            
            currentCropperInstance.setAspectRatio(aspectRatio);
        }
    });
    
    // Form submission handler
    document.querySelector('form').addEventListener('submit', function(e) {
        if (selectedImages.length === 0) {
            e.preventDefault();
            alert('Vui lòng chọn ít nhất một hình ảnh để tải lên!');
            return false;
        }
        
        // Create a new FormData object with the processed images
        const formData = new FormData(this);
        formData.delete('images'); // Remove original images
        
        selectedImages.forEach((imageData, index) => {
            formData.append('images', imageData.file);
        });
        
        // Submit form via AJAX if needed, or let it submit normally
        console.log(`Uploading ${selectedImages.length} images...`);
    });
</script>
{% endblock %}