{% extends "admin/base.html" %}

{% block title %}Chỉnh sửa Vị trí & Bản đồ{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="text-gradient font-weight-bold mb-2">
                        <i class="fas fa-edit mr-2"></i>
                        Chỉnh sửa Vị trí & Bản đồ
                    </h2>
                    <p class="text-muted mb-0">Cấu hình thông tin địa chỉ và bản đồ Google Maps cho website</p>
                </div>
                <a href="{{ url_for('admin_location') }}" class="btn btn-secondary btn-enhanced">
                    <i class="fas fa-arrow-left"></i> Quay lại
                </a>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12">
            <form method="POST">
                <!-- Google Maps Configuration Section -->
                <div class="form-section">
                    <h5>
                        <i class="fas fa-map-marked-alt"></i>
                        Cài đặt bản đồ từ Google Maps
                    </h5>
                    <p class="text-muted mb-4">Chỉ cần paste code iframe từ Google Maps để hiển thị bản đồ trên website.</p>
                    
                    <div class="form-group">
                        <label for="google_maps_embed" class="font-weight-bold">
                            <i class="fas fa-code mr-2 text-primary"></i>
                            Code nhúng Google Maps (iframe)
                        </label>
                        <textarea class="form-control form-control-enhanced" id="google_maps_embed" rows="6" placeholder='Paste code iframe từ Google Maps vào đây, ví dụ: <iframe src="https://www.google.com/maps/embed?pb=..." ...></iframe>'>{{ location_settings.google_maps_embed if location_settings else '' }}</textarea>
                        <div class="mt-3 p-3 bg-light rounded-lg">
                            <h6 class="font-weight-bold text-primary mb-2">
                                <i class="fas fa-info-circle mr-2"></i>
                                Cách lấy code iframe:
                            </h6>
                            <ol class="mb-0 text-muted">
                                <li>Truy cập <a href="https://www.google.com/maps" target="_blank" class="text-primary">Google Maps</a></li>
                                <li>Tìm địa điểm của bạn</li>
                                <li>Click "Chia sẻ" → "Nhúng bản đồ"</li>
                                <li>Copy toàn bộ code iframe và paste vào đây</li>
                            </ol>
                        </div>
                    </div>
                    
                    <div class="d-flex flex-wrap gap-2 mb-4">
                        <button type="button" class="btn btn-enhanced btn-info" id="extract-from-embed">
                            <i class="fas fa-magic"></i> 
                            Tự động lấy thông tin từ iframe
                        </button>
                        <button type="button" class="btn btn-enhanced btn-success" id="apply-location" disabled>
                            <i class="fas fa-map"></i> 
                            Áp dụng & Hiển thị bản đồ
                        </button>
                    </div>
                    
                    <!-- Hidden fields for form submission -->
                    <input type="hidden" id="address" name="address" value="{{ location_settings.address if location_settings else '' }}">
                    <input type="hidden" id="latitude" name="latitude" value="{{ location_settings.latitude if location_settings else '' }}">
                    <input type="hidden" id="longitude" name="longitude" value="{{ location_settings.longitude if location_settings else '' }}">
                    <input type="hidden" id="marker_title" name="marker_title" value="{{ location_settings.marker_title if location_settings else '' }}">
                    <input type="hidden" id="marker_info" name="marker_info" value="{{ location_settings.marker_info if location_settings else '' }}">
                    <input type="hidden" id="google_maps_api_key" name="google_maps_api_key" value="{{ location_settings.google_maps_api_key if location_settings else '' }}">
                    <input type="hidden" id="google_maps_embed" name="google_maps_embed" value="{{ location_settings.google_maps_embed if location_settings else '' }}">
                    <input type="hidden" id="map_zoom_level" name="map_zoom_level" value="{{ location_settings.map_zoom_level if location_settings else '15' }}">
                    <input type="hidden" id="map_style" name="map_style" value="{{ location_settings.map_style if location_settings else 'roadmap' }}">
                    <input type="hidden" id="map_height" name="map_height" value="{{ location_settings.map_height if location_settings else '400px' }}">
                    <input type="hidden" id="show_in_footer" name="show_in_footer" value="{{ 'true' if not location_settings or location_settings.show_in_footer else 'false' }}">
                    <input type="hidden" id="is_active" name="is_active" value="{{ 'true' if not location_settings or location_settings.is_active else 'false' }}">
                </div>
                
                <!-- Map Preview Section -->
                <div class="form-section">
                    <h5>
                        <i class="fas fa-eye"></i>
                        Xem trước bản đồ
                    </h5>
                    <div class="alert-enhanced alert-info mb-4">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-info-circle fa-2x mr-3"></i>
                            <div>
                                <h6 class="font-weight-bold mb-1">Hướng dẫn sử dụng</h6>
                                <p class="mb-0">Paste code iframe ở trên và click "Áp dụng & Hiển thị bản đồ" để xem bản đồ.</p>
                            </div>
                        </div>
                    </div>
                    <div class="map-container-enhanced">
                        <div id="location-picker-map" style="height: 400px; background: #f8f9fa; display: flex; align-items: center; justify-content: center; color: #6c757d;"></div>
                    </div>
                </div>
                
                <!-- Form Actions -->
                <div class="form-section">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="font-weight-bold text-muted mb-1">Sẵn sàng lưu thay đổi?</h6>
                            <small class="text-muted">Kiểm tra lại thông tin trước khi lưu</small>
                        </div>
                        <div class="d-flex gap-2">
                            <a href="{{ url_for('admin_location') }}" class="btn btn-enhanced btn-secondary">
                                <i class="fas fa-arrow-left"></i> 
                                Quay lại
                            </a>
                            <button type="submit" class="btn btn-enhanced btn-primary">
                                <i class="fas fa-save"></i> 
                                Lưu thay đổi
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let map;
let marker;
let isMapInitialized = false;

function initLocationPickerMap() {
    // Get current coordinates or use default (Ho Chi Minh City)
    const currentLat = parseFloat(document.getElementById('latitude').value) || 10.7769;
    const currentLng = parseFloat(document.getElementById('longitude').value) || 106.7009;
    const currentApiKey = document.getElementById('google_maps_api_key').value.trim();
    
    // Strict API key validation
    if (!currentApiKey || currentApiKey === '' || currentApiKey === 'None' || currentApiKey === 'null' || currentApiKey === 'undefined') {
        document.getElementById('location-picker-map').innerHTML = 
            '<div class="d-flex align-items-center justify-content-center h-100 bg-light">' +
            '<div class="text-center text-muted">' +
            '<i class="fas fa-map-marked-alt fa-3x mb-3"></i><br>' +
            '<strong>Cần Google Maps API Key</strong><br>' +
            'Vui lòng nhập API Key hợp lệ ở trên để hiển thị bản đồ tương tác<br>' +
            '<small class="text-muted">API Key phải bắt đầu bằng "AIza"</small>' +
            '</div></div>';
        return;
    }
    
    // Basic format validation
    if (!currentApiKey.startsWith('AIza') || currentApiKey.length < 30) {
        document.getElementById('location-picker-map').innerHTML = 
            '<div class="d-flex align-items-center justify-content-center h-100 bg-light">' +
            '<div class="text-center text-muted">' +
            '<i class="fas fa-exclamation-triangle fa-3x mb-3 text-warning"></i><br>' +
            '<strong>API Key không đúng định dạng</strong><br>' +
            'Google Maps API Key phải bắt đầu bằng "AIza"<br>' +
            '<small class="text-muted">Vui lòng kiểm tra lại API Key</small>' +
            '</div></div>';
        return;
    }
    
    try {
        const location = { lat: currentLat, lng: currentLng };
        
        map = new google.maps.Map(document.getElementById("location-picker-map"), {
            zoom: 15,
            center: location,
            mapTypeId: 'roadmap',
            mapId: 'location-picker-map' // Required for AdvancedMarkerElement
        });
        
        // Use AdvancedMarkerElement instead of deprecated Marker
        if (google.maps.marker && google.maps.marker.AdvancedMarkerElement) {
            marker = new google.maps.marker.AdvancedMarkerElement({
                position: location,
                map: map,
                title: 'Kéo thả để điều chỉnh vị trí',
                gmpDraggable: true
            });
            
            // Update coordinates when marker is dragged
            marker.addListener('dragend', function() {
                const position = marker.position;
                updateCoordinates(position.lat, position.lng);
            });
        } else {
            // Fallback to old Marker if AdvancedMarkerElement is not available
            marker = new google.maps.Marker({
                position: location,
                map: map,
                draggable: true,
                title: 'Kéo thả để điều chỉnh vị trí'
            });
            
            // Update coordinates when marker is dragged
            marker.addListener('dragend', function() {
                const position = marker.getPosition();
                updateCoordinates(position.lat(), position.lng());
            });
        }
        
        // Add marker when map is clicked
        map.addListener('click', function(event) {
            const position = event.latLng;
            if (google.maps.marker && google.maps.marker.AdvancedMarkerElement && marker instanceof google.maps.marker.AdvancedMarkerElement) {
                marker.position = { lat: position.lat(), lng: position.lng() };
            } else {
                marker.setPosition(position);
            }
            updateCoordinates(position.lat(), position.lng());
        });
        
        isMapInitialized = true;
        
    } catch (error) {
        console.error('Error initializing map:', error);
        document.getElementById('location-picker-map').innerHTML = 
            '<div class="d-flex align-items-center justify-content-center h-100 bg-light">' +
            '<div class="text-center text-muted">' +
            '<i class="fas fa-exclamation-triangle fa-3x mb-3 text-warning"></i><br>' +
            '<strong>Lỗi khởi tạo bản đồ</strong><br>' +
            'Vui lòng kiểm tra lại API Key hoặc kết nối internet' +
            '</div></div>';
    }
}

function updateCoordinates(lat, lng, skipReverseGeocode = false) {
    document.getElementById('latitude').value = lat.toFixed(6);
    document.getElementById('longitude').value = lng.toFixed(6);
    
    // Add visual feedback
    const latInput = document.getElementById('latitude');
    const lngInput = document.getElementById('longitude');
    
    latInput.style.backgroundColor = '#d4edda';
    lngInput.style.backgroundColor = '#d4edda';
    
    setTimeout(() => {
        latInput.style.backgroundColor = '';
        lngInput.style.backgroundColor = '';
    }, 1000);
    
    // Reverse geocoding to get address (optional)
    if (!skipReverseGeocode && typeof google !== 'undefined') {
        const geocoder = new google.maps.Geocoder();
        const latlng = { lat: lat, lng: lng };
        
        geocoder.geocode({ location: latlng }, function(results, status) {
            if (status === 'OK' && results[0]) {
                const addressField = document.getElementById('address');
                const currentAddress = addressField.value.trim();
                
                // Only update if current address is empty or default
                if (!currentAddress || currentAddress === '123 Đường Hoa Hướng Dương, Quận 1, TP.HCM') {
                    addressField.value = results[0].formatted_address;
                    addressField.style.borderColor = '#17a2b8';
                    setTimeout(() => {
                        addressField.style.borderColor = '';
                    }, 2000);
                }
            }
        });
    }
}

function loadGoogleMapsForPicker() {
    const apiKey = document.getElementById('google_maps_api_key').value.trim();
    
    // Strict API key validation
    if (!apiKey || apiKey === '' || apiKey === 'None' || apiKey === 'null' || apiKey === 'undefined') {
        initLocationPickerMap(); // Show message about needing API key
        return;
    }
    
    // Basic API key format validation (Google API keys start with AIza)
    if (!apiKey.startsWith('AIza') || apiKey.length < 30) {
        document.getElementById('location-picker-map').innerHTML = 
            '<div class="d-flex align-items-center justify-content-center h-100 bg-light">' +
            '<div class="text-center text-muted">' +
            '<i class="fas fa-exclamation-triangle fa-3x mb-3 text-warning"></i><br>' +
            '<strong>API Key không hợp lệ</strong><br>' +
            'Google Maps API Key phải bắt đầu bằng "AIza" và có ít nhất 30 ký tự' +
            '</div></div>';
        return;
    }
    
    if (typeof google === 'undefined') {
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(apiKey)}&libraries=marker&loading=async&callback=initLocationPickerMap`;
        script.async = true;
        script.defer = true;
        script.onerror = function() {
            console.error('Failed to load Google Maps API');
            document.getElementById('location-picker-map').innerHTML = 
                '<div class="d-flex align-items-center justify-content-center h-100 bg-light">' +
                '<div class="text-center text-muted">' +
                '<i class="fas fa-exclamation-triangle fa-3x mb-3 text-danger"></i><br>' +
                '<strong>Không thể tải Google Maps</strong><br>' +
                'Vui lòng kiểm tra API Key và kết nối internet' +
                '</div></div>';
        };
        document.head.appendChild(script);
    } else {
        initLocationPickerMap();
    }
}



// Initialize map when API key is entered
document.getElementById('google_maps_api_key').addEventListener('blur', function() {
    const apiKey = this.value.trim();
    if (apiKey && apiKey !== '' && apiKey !== 'None' && !isMapInitialized) {
        loadGoogleMapsForPicker();
    }
});

// Extract information from Google Maps embed iframe
function extractFromEmbed() {
    const embedCode = document.getElementById('google_maps_embed').value;
    
    if (!embedCode.trim()) {
        alert('Vui lòng paste code iframe từ Google Maps');
        return;
    }
    
    try {
        // Extract src URL from iframe
        const srcMatch = embedCode.match(/src="([^"]+)"/);
        if (!srcMatch) {
            alert('Không tìm thấy URL trong iframe code');
            return;
        }
        
        const url = srcMatch[1];
        console.log('Extracted URL:', url);
        
        // Extract coordinates from pb parameter
        const pbMatch = url.match(/pb=([^&]+)/);
        if (pbMatch) {
            const pbData = decodeURIComponent(pbMatch[1]);
            console.log('PB Data:', pbData);
            
            // Parse pb data to extract coordinates
            // Format: !1m18!1m12!1m3!1d[distance]!2d[lng]!3d[lat]!...
            const coordMatches = pbData.match(/!3d([0-9.-]+)!2d([0-9.-]+)/);
            if (coordMatches) {
                const lat = parseFloat(coordMatches[1]);
                const lng = parseFloat(coordMatches[2]);
                
                console.log('Extracted coordinates:', lat, lng);
                
                if (!isNaN(lat) && !isNaN(lng)) {
                    updateCoordinates(lat, lng, true); // Skip reverse geocoding
                    
                    // Save iframe code to hidden field
                    document.getElementById('google_maps_embed').value = embedCode;
                    
                    // Enable apply button
                    document.getElementById('apply-location').disabled = false;
                    
                    // Show success message
                    const embedField = document.getElementById('google_maps_embed');
                    embedField.style.borderColor = '#28a745';
                    setTimeout(() => {
                        embedField.style.borderColor = '';
                    }, 2000);
                    
                    // Try to extract place name from URL
                    const placeNameMatch = url.match(/!1s0x[^!]+!2s([^!]+)/);
                    if (placeNameMatch) {
                        const placeName = decodeURIComponent(placeNameMatch[1]).replace(/\+/g, ' ');
                        const addressField = document.getElementById('address');
                        if (!addressField.value.trim() || addressField.value === '123 Đường Hoa Hướng Dương, Quận 1, TP.HCM') {
                            addressField.value = placeName;
                        }
                        
                        // Update marker title
                        const markerTitleField = document.getElementById('marker_title');
                        if (!markerTitleField.value.trim() || markerTitleField.value === 'Trường Mầm non Hoa Hướng Dương') {
                            markerTitleField.value = placeName;
                        }
                    }
                    
                    alert(`Đã trích xuất thông tin thành công!\nVĩ độ: ${lat}\nKinh độ: ${lng}\n\nClick "Áp dụng & Hiển thị bản đồ" để xem bản đồ.`);
                    return;
                }
            }
        }
        
        // Alternative method: extract from direct coordinate format
        const directCoordMatch = url.match(/!2d([0-9.-]+)!3d([0-9.-]+)/);
        if (directCoordMatch) {
            const lng = parseFloat(directCoordMatch[1]);
            const lat = parseFloat(directCoordMatch[2]);
            
            if (!isNaN(lat) && !isNaN(lng)) {
                updateCoordinates(lat, lng, true);
                
                // Save iframe code to hidden field
                document.getElementById('google_maps_embed').value = embedCode;
                
                // Enable apply button
                document.getElementById('apply-location').disabled = false;
                
                // Try to extract place name from URL
                const placeNameMatch = url.match(/!1s0x[^!]+!2s([^!]+)/);
                if (placeNameMatch) {
                    const placeName = decodeURIComponent(placeNameMatch[1]).replace(/\+/g, ' ');
                    const addressField = document.getElementById('address');
                    if (!addressField.value.trim() || addressField.value === '123 Đường Hoa Hướng Dương, Quận 1, TP.HCM') {
                        addressField.value = placeName;
                    }
                    
                    const markerTitleField = document.getElementById('marker_title');
                    if (!markerTitleField.value.trim() || markerTitleField.value === 'Trường Mầm non Hoa Hướng Dương') {
                        markerTitleField.value = placeName;
                    }
                }
                
                alert(`Đã trích xuất thông tin thành công!\nVĩ độ: ${lat}\nKinh độ: ${lng}\n\nClick "Áp dụng & Hiển thị bản đồ" để xem bản đồ.`);
                return;
            }
        }
        
        alert('Không thể trích xuất tọa độ từ iframe code này. Vui lòng kiểm tra lại.');
        
    } catch (error) {
        console.error('Error extracting coordinates:', error);
        alert('Có lỗi xảy ra khi trích xuất tọa độ. Vui lòng kiểm tra lại iframe code.');
    }
}

// Apply location and show map
function applyLocation() {
    console.log('🎯 Apply Location button clicked!');
    const lat = parseFloat(document.getElementById('latitude').value);
    const lng = parseFloat(document.getElementById('longitude').value);
    console.log('📍 Coordinates:', lat, lng);
    
    if (isNaN(lat) || isNaN(lng)) {
        alert('Vui lòng trích xuất tọa độ từ iframe trước');
        return;
    }
    
    // Check API Key
    const apiKey = document.getElementById('google_maps_api_key').value.trim();
    if (!apiKey || apiKey === '' || apiKey === 'None' || apiKey === 'null' || apiKey === 'undefined') {
        // Show iframe map instead of interactive map
        const embedCode = document.getElementById('google_maps_embed').value;
        
        if (embedCode.trim()) {
            // Use the iframe from user input
            document.getElementById('location-picker-map').innerHTML = 
                '<div class="border rounded overflow-hidden">' +
                '<div class="bg-primary text-white p-2 small">' +
                '<i class="fas fa-map-marked-alt"></i> Bản đồ từ Google Maps (iframe)' +
                '</div>' +
                '<div style="position: relative; width: 100%; height: 400px;">' +
                embedCode.replace(/width="[^"]*"/g, 'width="100%"').replace(/height="[^"]*"/g, 'height="100%"') +
                '</div>' +
                '</div>';
        } else {
            // Generate iframe URL from coordinates
            const iframeUrl = `https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3000!2d${lng}!3d${lat}!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x0%3A0x0!2zM!5e0!3m2!1sen!2s!4v${Date.now()}!5m2!1sen!2s`;
            
            document.getElementById('location-picker-map').innerHTML = 
                '<div class="border rounded overflow-hidden">' +
                '<div class="bg-success text-white p-2 small">' +
                '<i class="fas fa-map-marked-alt"></i> Bản đồ được tạo từ tọa độ' +
                '</div>' +
                '<div style="position: relative; width: 100%; height: 400px;">' +
                `<iframe src="${iframeUrl}" width="100%" height="100%" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>` +
                '</div>' +
                `<div class="bg-light p-2 small text-muted">` +
                `📍 Vĩ độ: ${lat} | Kinh độ: ${lng}` +
                '</div>' +
                '</div>';
        }
        
        alert('✅ Đã hiển thị bản đồ từ iframe!\n\n' +
              '📍 Tọa độ đã được áp dụng:\n' +
              `• Vĩ độ: ${lat}\n` +
              `• Kinh độ: ${lng}\n\n` +
              '🗺️ Bản đồ hiển thị dưới dạng iframe (không tương tác)\n' +
              '🔑 Để có bản đồ tương tác, vui lòng nhập Google Maps API Key');
        return;
    }
    
    // Basic API key format validation
    if (!apiKey.startsWith('AIza') || apiKey.length < 30) {
        alert('⚠️ Google Maps API Key không hợp lệ!\n\n' +
              '🔑 API Key phải:\n' +
              '• Bắt đầu bằng "AIza"\n' +
              '• Có ít nhất 30 ký tự\n\n' +
              '📍 Tọa độ vẫn đã được áp dụng:\n' +
              `• Vĩ độ: ${lat}\n` +
              `• Kinh độ: ${lng}`);
        
        // Show invalid API key message
        document.getElementById('location-picker-map').innerHTML = 
            '<div class="d-flex align-items-center justify-content-center h-100 bg-light border rounded">' +
            '<div class="text-center text-warning">' +
            '<i class="fas fa-exclamation-triangle fa-3x mb-3"></i><br>' +
            '<strong>⚠️ API Key không hợp lệ</strong><br>' +
            '<div class="mt-2 text-muted small">' +
            'Google Maps API Key phải bắt đầu bằng "AIza" và có ít nhất 30 ký tự' +
            '</div>' +
            `<div class="mt-3 text-success">📍 Tọa độ: ${lat}, ${lng}</div>` +
            '</div></div>';
        return;
    }
    
    // Load and show map with valid API key
    loadGoogleMapsForPicker();
    
    // Show loading message
    document.getElementById('location-picker-map').innerHTML = 
        '<div class="d-flex align-items-center justify-content-center h-100 bg-light border rounded">' +
        '<div class="text-center text-info">' +
        '<i class="fas fa-spinner fa-spin fa-3x mb-3"></i><br>' +
        '<strong>🗺️ Đang tải bản đồ...</strong><br>' +
        `<div class="mt-2">📍 Vĩ độ: ${lat} | Kinh độ: ${lng}</div>` +
        '</div></div>';
}

// Sync iframe code from textarea to hidden field
document.getElementById('google_maps_embed').addEventListener('input', function() {
    // Update hidden field when user types/pastes in textarea
    const hiddenField = document.querySelector('input[name="google_maps_embed"]');
    if (hiddenField) {
        hiddenField.value = this.value;
    }
});

// Add extract from embed button event
document.getElementById('extract-from-embed').addEventListener('click', extractFromEmbed);

// Add apply location button event
document.getElementById('apply-location').addEventListener('click', applyLocation);

// Update marker position when coordinates are manually changed
document.getElementById('latitude').addEventListener('change', function() {
    if (isMapInitialized && marker) {
        const lat = parseFloat(this.value);
        const lng = parseFloat(document.getElementById('longitude').value);
        if (!isNaN(lat) && !isNaN(lng)) {
            const newPosition = { lat: lat, lng: lng };
            if (google.maps.marker && google.maps.marker.AdvancedMarkerElement && marker instanceof google.maps.marker.AdvancedMarkerElement) {
                marker.position = newPosition;
            } else {
                marker.setPosition(newPosition);
            }
            map.setCenter(newPosition);
        }
    }
});

document.getElementById('longitude').addEventListener('change', function() {
    if (isMapInitialized && marker) {
        const lat = parseFloat(document.getElementById('latitude').value);
        const lng = parseFloat(this.value);
        if (!isNaN(lat) && !isNaN(lng)) {
            const newPosition = { lat: lat, lng: lng };
            if (google.maps.marker && google.maps.marker.AdvancedMarkerElement && marker instanceof google.maps.marker.AdvancedMarkerElement) {
                marker.position = newPosition;
            } else {
                marker.setPosition(newPosition);
            }
            map.setCenter(newPosition);
        }
    }
});

// Initialize map on page load - just show placeholder
document.addEventListener('DOMContentLoaded', function() {
    initLocationPickerMap(); // Show message about needing API key or coordinates
    
    // Sync initial iframe code from textarea to hidden field
    const textareaField = document.getElementById('google_maps_embed');
    const hiddenField = document.querySelector('input[name="google_maps_embed"]');
    if (textareaField && hiddenField && textareaField.value) {
        hiddenField.value = textareaField.value;
    }
    
    // Enable apply button if coordinates exist
    const lat = parseFloat(document.getElementById('latitude').value);
    const lng = parseFloat(document.getElementById('longitude').value);
    if (!isNaN(lat) && !isNaN(lng)) {
        document.getElementById('apply-location').disabled = false;
    }
});
</script>

<style>
/* Additional inline styles for edit page */
.text-gradient {
    background: linear-gradient(45deg, #ff6b35, #f7931e);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.gap-2 {
    gap: 0.5rem;
}

.rounded-lg {
    border-radius: 0.5rem;
}

.font-weight-medium {
    font-weight: 500;
}

/* Enhanced button styles for better compatibility */
.btn-enhanced.btn-secondary {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
}

.btn-enhanced.btn-secondary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(108, 117, 125, 0.4);
    color: white;
}

.btn-enhanced.btn-primary {
    background: linear-gradient(45deg, #ff6b35, #f7931e);
    color: white;
    box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
}

.btn-enhanced.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(255, 107, 53, 0.4);
    color: white;
}

/* Form animations */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.form-section {
    animation: fadeInUp 0.6s ease-out;
}

.form-section:nth-child(2) {
    animation-delay: 0.1s;
}

.form-section:nth-child(3) {
    animation-delay: 0.2s;
}

.form-section:nth-child(4) {
    animation-delay: 0.3s;
}

/* Loading state for map */
#location-picker-map:empty::before {
    content: "Đang tải bản đồ...";
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #6c757d;
    font-style: italic;
}

/* Responsive improvements */
@media (max-width: 768px) {
    .d-flex.gap-2 {
        flex-direction: column;
    }
    
    .btn-enhanced {
        width: 100%;
        margin-bottom: 0.5rem;
    }
    
    .form-section {
        padding: 1.5rem;
    }
}
</style>

{% endblock %}
