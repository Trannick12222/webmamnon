{% extends "admin/base.html" %}

{% block title %}Cài đặt Vị trí & Bản đồ{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
<style>
.location-edit-container {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 2rem 0;
}

.main-card {
    background: white;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.1);
    overflow: hidden;
    margin-bottom: 2rem;
}

.card-header-custom {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem;
    text-align: center;
    position: relative;
}

.card-header-custom::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
    opacity: 0.3;
}

.card-header-custom h1 {
    font-size: 2.5rem;
    font-weight: 700;
    margin: 0;
    position: relative;
    z-index: 1;
}

.card-header-custom p {
    font-size: 1.1rem;
    margin: 0.5rem 0 0 0;
    opacity: 0.9;
    position: relative;
    z-index: 1;
}

.section-card {
    background: white;
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    border: 1px solid #f0f0f0;
    transition: all 0.3s ease;
}

.section-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 40px rgba(0,0,0,0.12);
}

.section-title {
    color: #2d3748;
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
}

.section-title i {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
}

/* Form Elements */
.form-label {
    font-weight: 600;
    color: #2d3748;
    font-size: 1.1rem;
}

.code-input-container {
    position: relative;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
}

.code-textarea {
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 13px;
    line-height: 1.6;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    padding: 1.5rem;
    background: #f8fafc;
    transition: all 0.3s ease;
    resize: vertical;
    min-height: 150px;
}

.code-textarea:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    background: white;
}

.btn-clear {
    position: absolute;
    top: 15px;
    right: 15px;
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 8px;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    opacity: 0.8;
}

.btn-clear:hover {
    opacity: 1;
    transform: scale(1.1);
    background: #dc2626;
}

/* Guide Card */
.guide-card {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border: 1px solid #bae6fd;
    border-radius: 12px;
    padding: 1.5rem;
    margin-top: 1.5rem;
}

.guide-header {
    display: flex;
    align-items: center;
    margin-bottom: 1rem;
    color: #0369a1;
    font-weight: 600;
    font-size: 1.1rem;
}

.guide-header i {
    margin-right: 0.5rem;
    font-size: 1.2rem;
}

.guide-steps {
    display: grid;
    gap: 0.75rem;
}

.step {
    display: flex;
    align-items: center;
    color: #1e40af;
}

.step-number {
    background: #3b82f6;
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.875rem;
    font-weight: 600;
    margin-right: 0.75rem;
    flex-shrink: 0;
}

.step a {
    color: #2563eb;
    text-decoration: none;
    font-weight: 500;
}

.step a:hover {
    text-decoration: underline;
}

/* Action Buttons */
.action-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin-top: 2rem;
}

.btn-action {
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 16px;
    padding: 1.5rem;
    display: flex;
    align-items: center;
    text-align: left;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.btn-action::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    transition: left 0.5s;
}

.btn-action:hover::before {
    left: 100%;
}

.btn-analyze {
    border-color: #3b82f6;
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
}

.btn-analyze:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 40px rgba(59, 130, 246, 0.3);
    border-color: #2563eb;
}

.btn-preview {
    border-color: #10b981;
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
}

.btn-preview:hover:not(:disabled) {
    transform: translateY(-4px);
    box-shadow: 0 12px 40px rgba(16, 185, 129, 0.3);
    border-color: #059669;
}

.btn-preview:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
    border-color: #d1d5db;
}

.btn-icon {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    width: 60px;
    height: 60px;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1.5rem;
    font-size: 1.5rem;
    flex-shrink: 0;
}

.btn-analyze .btn-icon {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
}

.btn-preview .btn-icon {
    background: linear-gradient(135deg, #10b981 0%, #047857 100%);
}

.btn-preview:disabled .btn-icon {
    background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
}

.btn-content h4 {
    margin: 0 0 0.5rem 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: #1f2937;
}

.btn-content p {
    margin: 0;
    color: #6b7280;
    font-size: 0.95rem;
}

/* Status Badge */
.status-badge {
    display: flex;
    align-items: center;
    background: white;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    border: 1px solid #e2e8f0;
    font-size: 0.875rem;
    font-weight: 500;
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #9ca3af;
    margin-right: 0.5rem;
}

.status-dot.active {
    background: #10b981;
}

.status-dot.warning {
    background: #f59e0b;
}

/* Map Preview */
.map-preview-container {
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 8px 32px rgba(0,0,0,0.12);
    margin-top: 1.5rem;
}

.map-display {
    height: 400px;
    width: 100%;
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}

.map-placeholder {
    text-align: center;
    color: #64748b;
}

.placeholder-icon {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    width: 80px;
    height: 80px;
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1.5rem;
    font-size: 2rem;
}

.map-placeholder h4 {
    color: #374151;
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.map-placeholder p {
    color: #6b7280;
    margin: 0;
}

/* Form Actions */
.form-actions {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    border-radius: 16px;
    padding: 2rem;
    margin-top: 2rem;
    border: 1px solid #e2e8f0;
}

.actions-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.action-info h4 {
    color: #1f2937;
    margin: 0 0 0.5rem 0;
    font-weight: 600;
    font-size: 1.25rem;
}

.action-info p {
    color: #6b7280;
    margin: 0;
}

.action-buttons-footer {
    display: flex;
    gap: 1rem;
}

.btn-secondary-action, .btn-primary-action {
    padding: 0.75rem 1.5rem;
    border-radius: 12px;
    font-weight: 600;
    text-decoration: none;
    display: flex;
    align-items: center;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
}

.btn-secondary-action {
    background: #6b7280;
    color: white;
}

.btn-secondary-action:hover {
    background: #4b5563;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(107, 114, 128, 0.3);
    color: white;
    text-decoration: none;
}

.btn-primary-action {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.btn-primary-action:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
}

.btn-secondary-action i, .btn-primary-action i {
    margin-right: 0.5rem;
}

/* Modern Address Section */
.address-section {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    border-radius: 16px;
    padding: 2rem;
    margin: 1.5rem 0;
    border: 1px solid #e2e8f0;
    position: relative;
    overflow: hidden;
}

.address-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #3b82f6, #10b981, #f59e0b, #ef4444);
}

.address-input-group {
    position: relative;
    margin-bottom: 1.5rem;
}

.address-input {
    border: 2px solid #e2e8f0;
    border-radius: 16px;
    padding: 1.25rem 1.5rem;
    font-size: 1.1rem;
    transition: all 0.3s ease;
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    width: 100%;
}

.address-input:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1), 0 4px 12px rgba(0,0,0,0.1);
    background: white;
    transform: translateY(-1px);
}

.address-input::placeholder {
    color: #9ca3af;
    font-style: italic;
}

/* Modern Address Preview */
.address-preview {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 16px;
    overflow: hidden;
    height: fit-content;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
}

.address-preview:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.12);
}

.preview-header {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: white;
    padding: 1rem 1.25rem;
    font-size: 0.9rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    position: relative;
}

.preview-header::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, rgba(255,255,255,0.3), rgba(255,255,255,0.1));
}

.preview-header i {
    margin-right: 0.75rem;
    font-size: 1rem;
}

.preview-content {
    padding: 1.25rem;
    background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
}

.address-display {
    color: #1f2937;
    font-weight: 500;
    line-height: 1.6;
    min-height: 2rem;
    font-size: 0.95rem;
    padding: 0.5rem;
    background: #f1f5f9;
    border-radius: 8px;
    border-left: 4px solid #3b82f6;
}

/* Marker Info Cards */
.marker-info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin-top: 2rem;
}

.marker-field {
    background: white;
    border-radius: 16px;
    padding: 1.5rem;
    border: 2px solid #f1f5f9;
    transition: all 0.3s ease;
    position: relative;
}

.marker-field:hover {
    border-color: #e2e8f0;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}

.marker-field::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    border-radius: 16px 16px 0 0;
    background: linear-gradient(90deg, #10b981, #3b82f6);
}

.marker-label {
    display: flex;
    align-items: center;
    margin-bottom: 1rem;
    font-weight: 600;
    color: #374151;
    font-size: 1rem;
}

.marker-label i {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 0.75rem;
    font-size: 0.9rem;
}

.marker-label .fa-tag {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
}

.marker-label .fa-info-circle {
    background: linear-gradient(135deg, #10b981 0%, #047857 100%);
    color: white;
}

.marker-input {
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 1rem 1.25rem;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: #f9fafb;
    width: 100%;
}

.marker-input:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    background: white;
    transform: translateY(-1px);
}

.marker-input::placeholder {
    color: #9ca3af;
    font-style: italic;
}

/* Info Helper */
.info-helper {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border: 1px solid #f59e0b;
    border-radius: 12px;
    padding: 1rem;
    margin-top: 1rem;
    display: flex;
    align-items: flex-start;
}

.info-helper i {
    color: #d97706;
    margin-right: 0.75rem;
    margin-top: 0.125rem;
    flex-shrink: 0;
}

.info-helper-text {
    color: #92400e;
    font-size: 0.875rem;
    line-height: 1.5;
    font-weight: 500;
}

/* Form Control Styling */
.form-control {
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    padding: 0.75rem 1rem;
    transition: all 0.3s ease;
    background: #f8fafc;
}

.form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    background: white;
}

/* Modern Settings Cards */
.setting-card {
    background: white;
    border: 2px solid #f1f5f9;
    border-radius: 16px;
    padding: 1.5rem;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.setting-card:hover {
    border-color: #e2e8f0;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}

.setting-header {
    display: flex;
    align-items: flex-start;
    margin-bottom: 1.5rem;
}

.setting-icon {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    font-size: 1.25rem;
    flex-shrink: 0;
}

.footer-icon {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: white;
}

.status-icon {
    background: linear-gradient(135deg, #10b981 0%, #047857 100%);
    color: white;
}

.setting-info {
    flex: 1;
}

.setting-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #1f2937;
    margin: 0 0 0.25rem 0;
}

.setting-desc {
    font-size: 0.875rem;
    color: #6b7280;
    margin: 0;
    line-height: 1.4;
}

.setting-control {
    margin-bottom: 1rem;
}

/* Modern Switch */
.modern-switch {
    position: relative;
    display: inline-block;
}

.switch-input {
    opacity: 0;
    width: 0;
    height: 0;
}

.switch-label {
    display: flex;
    align-items: center;
    cursor: pointer;
    user-select: none;
    margin: 0;
}

.switch-slider {
    position: relative;
    width: 60px;
    height: 32px;
    background: #cbd5e1;
    border-radius: 16px;
    transition: all 0.3s ease;
    margin-right: 0.75rem;
}

.switch-slider::before {
    content: '';
    position: absolute;
    top: 2px;
    left: 2px;
    width: 28px;
    height: 28px;
    background: white;
    border-radius: 50%;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.switch-input:checked + .switch-label .switch-slider {
    background: linear-gradient(135deg, #10b981 0%, #047857 100%);
}

.switch-input:checked + .switch-label .switch-slider::before {
    transform: translateX(28px);
}

.switch-text {
    font-weight: 600;
    font-size: 0.875rem;
}

.switch-on, .switch-off {
    transition: all 0.3s ease;
}

.switch-input:checked + .switch-label .switch-off {
    display: none;
}

.switch-input:not(:checked) + .switch-label .switch-on {
    display: none;
}

.switch-input:checked + .switch-label .switch-on {
    color: #10b981;
}

.switch-input:not(:checked) + .switch-label .switch-off {
    color: #6b7280;
}

/* Setting Status */
.setting-status {
    padding: 0.75rem;
    background: #f8fafc;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
}

.status-indicator {
    display: flex;
    align-items: center;
    font-size: 0.875rem;
    font-weight: 500;
}

.status-indicator i {
    margin-right: 0.5rem;
    font-size: 1rem;
}

.status-indicator.active {
    color: #059669;
}

.status-indicator.inactive {
    color: #dc2626;
}

/* Preview Section */
.preview-section {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    border-radius: 16px;
    padding: 1.5rem;
    margin-top: 2rem;
    border: 1px solid #e2e8f0;
}

.preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.preview-title {
    display: flex;
    align-items: center;
    font-weight: 600;
    color: #374151;
    font-size: 1.1rem;
}

.preview-title i {
    margin-right: 0.5rem;
    color: #6366f1;
}

.preview-badge .badge {
    background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
    color: white;
    font-size: 0.75rem;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
}

.preview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
}

.preview-card {
    background: white;
    border-radius: 12px;
    padding: 1.25rem;
    border: 1px solid #e5e7eb;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
}

.preview-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.preview-icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    flex-shrink: 0;
}

.preview-content {
    flex: 1;
}

.preview-content h6 {
    margin: 0 0 0.5rem 0;
    font-weight: 600;
    color: #374151;
    font-size: 0.95rem;
}

.preview-status {
    display: flex;
    align-items: center;
    font-size: 0.875rem;
    font-weight: 500;
}

.preview-status i {
    margin-right: 0.5rem;
}

/* Responsive Design */
@media (max-width: 768px) {
    .location-edit-container {
        padding: 1rem 0;
    }
    
    .card-header-custom {
        padding: 1.5rem;
    }
    
    .card-header-custom h1 {
        font-size: 2rem;
    }
    
    .section-card {
        padding: 1.5rem;
    }
    
    .action-buttons {
        grid-template-columns: 1fr;
    }
    
    .actions-content {
        flex-direction: column;
        gap: 1.5rem;
        text-align: center;
    }
    
    .action-buttons-footer {
        width: 100%;
        justify-content: center;
    }
    
    .map-display {
        height: 300px;
    }
    
    .address-preview {
        margin-top: 1rem;
    }
    
    .setting-card {
        margin-bottom: 1rem;
    }
    
    .setting-header {
        flex-direction: column;
        text-align: center;
        margin-bottom: 1rem;
    }
    
    .setting-icon {
        margin: 0 auto 0.75rem auto;
    }
    
    .preview-grid {
        grid-template-columns: 1fr;
    }
    
    .preview-header {
        flex-direction: column;
        gap: 0.75rem;
        text-align: center;
    }
    
    .address-section {
        padding: 1.5rem;
    }
    
    .marker-info-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .marker-field {
        padding: 1.25rem;
    }
    
    .address-input {
        font-size: 1rem;
        padding: 1rem 1.25rem;
    }
    
    .marker-input {
        font-size: 0.95rem;
        padding: 0.875rem 1rem;
    }
    
    .info-helper {
        margin-top: 1.5rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="location-edit-container">
    <div class="container">
        <!-- Main Card -->
        <div class="main-card">
            <!-- Header -->
            <div class="card-header-custom">
                <h1><i class="fas fa-map-marked-alt mr-3"></i>Cài đặt Vị trí & Bản đồ</h1>
                <p>Cấu hình thông tin địa chỉ và hiển thị bản đồ Google Maps cho website của bạn</p>
            </div>
            
            <!-- Content -->
            <div class="p-4">
                <form method="POST">
                    <!-- Step 1: Google Maps Configuration -->
                    <div class="section-card">
                        <div class="section-title">
                            <i class="fas fa-code"></i>
                            <div>
                                <h3 class="mb-1">Bước 1: Nhúng bản đồ Google Maps</h3>
                                <small class="text-muted">Paste code iframe từ Google Maps để hiển thị bản đồ</small>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="google_maps_embed" class="form-label mb-3">
                                <i class="fas fa-code mr-2"></i>
                                Code iframe từ Google Maps
                            </label>
                            <div class="code-input-container">
                                <textarea 
                                    class="form-control code-textarea" 
                                    id="google_maps_embed" 
                                    rows="6" 
                                    placeholder='Paste code iframe từ Google Maps vào đây...'
                                >{{ location_settings.google_maps_embed if location_settings else '' }}</textarea>
                                <button type="button" class="btn btn-clear" id="clear-embed" title="Xóa nội dung">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Quick Guide -->
                        <div class="guide-card">
                            <div class="guide-header">
                                <i class="fas fa-lightbulb"></i>
                                <span>Hướng dẫn lấy code iframe</span>
                            </div>
                            <div class="guide-steps">
                                <div class="step">
                                    <span class="step-number">1</span>
                                    <span>Truy cập <a href="https://www.google.com/maps" target="_blank">Google Maps</a></span>
                                </div>
                                <div class="step">
                                    <span class="step-number">2</span>
                                    <span>Tìm kiếm địa điểm của bạn</span>
                                </div>
                                <div class="step">
                                    <span class="step-number">3</span>
                                    <span>Click "Chia sẻ" → "Nhúng bản đồ"</span>
                                </div>
                                <div class="step">
                                    <span class="step-number">4</span>
                                    <span>Copy toàn bộ code iframe</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="action-buttons">
                            <button type="button" class="btn-action btn-analyze" id="extract-from-embed">
                                <div class="btn-icon">
                                    <i class="fas fa-magic"></i>
                                </div>
                                <div class="btn-content">
                                    <h4>Tự động phân tích</h4>
                                    <p>Trích xuất thông tin từ code iframe</p>
                                </div>
                            </button>
                            
                            <button type="button" class="btn-action btn-preview" id="apply-location" disabled>
                                <div class="btn-icon">
                                    <i class="fas fa-eye"></i>
                                </div>
                                <div class="btn-content">
                                    <h4>Xem trước bản đồ</h4>
                                    <p>Hiển thị bản đồ ở bên dưới</p>
                                </div>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Step 1.5: Address Information -->
                    <div class="section-card">
                        <div class="section-title">
                            <i class="fas fa-map-marker-alt"></i>
                            <div>
                                <h3 class="mb-1">Bước 1.5: Thông tin địa chỉ</h3>
                                <small class="text-muted">Cập nhật địa chỉ và thông tin hiển thị trên website</small>
                            </div>
                        </div>
                        
                        <!-- Address Input Section -->
                        <div class="address-section">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="address-input-group">
                                        <label for="address_display" class="form-label mb-3">
                                            <i class="fas fa-home mr-2"></i>
                                            <strong>Địa chỉ hiển thị chính</strong>
                                        </label>
                                        <input 
                                            type="text" 
                                            class="address-input" 
                                            id="address_display" 
                                            name="address"
                                            value="{{ location_settings.address if location_settings else '123 Đường Hoa Hướng Dương, Quận 1, TP.HCM' }}"
                                            placeholder="Nhập địa chỉ đầy đủ của trường mầm non..."
                                        >
                                    </div>
                                    
                                    <div class="info-helper">
                                        <i class="fas fa-lightbulb"></i>
                                        <div class="info-helper-text">
                                            <strong>Mẹo:</strong> Địa chỉ này sẽ hiển thị trên website, footer và trong thông tin liên hệ. 
                                            Hãy nhập đầy đủ để khách hàng dễ dàng tìm thấy trường.
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="address-preview">
                                        <div class="preview-header">
                                            <i class="fas fa-eye"></i>
                                            <span>Xem trước hiển thị</span>
                                        </div>
                                        <div class="preview-content">
                                            <div class="address-display" id="address-preview">
                                                {{ location_settings.address if location_settings else '123 Đường Hoa Hướng Dương, Quận 1, TP.HCM' }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Marker Information -->
                        <div class="marker-info-grid">
                            <div class="marker-field">
                                <label for="marker_title_display" class="marker-label">
                                    <i class="fas fa-tag"></i>
                                    <span>Tiêu đề trên bản đồ</span>
                                </label>
                                <input 
                                    type="text" 
                                    class="marker-input" 
                                    id="marker_title_display" 
                                    name="marker_title"
                                    value="{{ location_settings.marker_title if location_settings else 'Trường Mầm non Hoa Hướng Dương' }}"
                                    placeholder="Tên trường hiển thị trên marker..."
                                >
                            </div>
                            
                            <div class="marker-field">
                                <label for="marker_info_display" class="marker-label">
                                    <i class="fas fa-info-circle"></i>
                                    <span>Mô tả chi tiết</span>
                                </label>
                                <input 
                                    type="text" 
                                    class="marker-input" 
                                    id="marker_info_display" 
                                    name="marker_info"
                                    value="{{ location_settings.marker_info if location_settings else 'Trường Mầm non Hoa Hướng Dương - Nuôi dưỡng tâm hồn, phát triển tài năng' }}"
                                    placeholder="Slogan hoặc mô tả ngắn về trường..."
                                >
                            </div>
                        </div>
                    </div>
                    
                    <!-- Step 3: Display Settings -->
                    <div class="section-card">
                        <div class="section-title">
                            <i class="fas fa-sliders-h"></i>
                            <div>
                                <h3 class="mb-1">Bước 3: Cài đặt hiển thị</h3>
                                <small class="text-muted">Cấu hình cách hiển thị bản đồ trên website của bạn</small>
                            </div>
                        </div>
                        
                        <!-- Settings Cards -->
                        <div class="row">
                            <!-- Footer Display Setting -->
                            <div class="col-md-6 mb-4">
                                <div class="setting-card h-100">
                                    <div class="setting-header">
                                        <div class="setting-icon footer-icon">
                                            <i class="fas fa-map-marked-alt"></i>
                                        </div>
                                        <div class="setting-info">
                                            <h5 class="setting-title">Hiển thị trong Footer</h5>
                                            <p class="setting-desc">Bản đồ xuất hiện ở cuối trang website</p>
                                        </div>
                                    </div>
                                    
                                    <div class="setting-control">
                                        <div class="modern-switch">
                                            <input type="checkbox" 
                                                   class="switch-input" 
                                                   id="show_in_footer_toggle" 
                                                   name="show_in_footer" 
                                                   value="true"
                                                   {% if not location_settings or location_settings.show_in_footer %}checked{% endif %}>
                                            <label class="switch-label" for="show_in_footer_toggle">
                                                <span class="switch-slider"></span>
                                                <span class="switch-text">
                                                    <span class="switch-on">BẬT</span>
                                                    <span class="switch-off">TẮT</span>
                                                </span>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="setting-status" id="footer-status-card">
                                        <div class="status-indicator active">
                                            <i class="fas fa-check-circle"></i>
                                            <span>Bản đồ sẽ hiển thị trong footer</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Active Status Setting -->
                            <div class="col-md-6 mb-4">
                                <div class="setting-card h-100">
                                    <div class="setting-header">
                                        <div class="setting-icon status-icon">
                                            <i class="fas fa-power-off"></i>
                                        </div>
                                        <div class="setting-info">
                                            <h5 class="setting-title">Trạng thái hoạt động</h5>
                                            <p class="setting-desc">Bật/tắt toàn bộ tính năng vị trí</p>
                                        </div>
                                    </div>
                                    
                                    <div class="setting-control">
                                        <div class="modern-switch">
                                            <input type="checkbox" 
                                                   class="switch-input" 
                                                   id="is_active_toggle" 
                                                   name="is_active" 
                                                   value="true"
                                                   {% if not location_settings or location_settings.is_active %}checked{% endif %}>
                                            <label class="switch-label" for="is_active_toggle">
                                                <span class="switch-slider"></span>
                                                <span class="switch-text">
                                                    <span class="switch-on">BẬT</span>
                                                    <span class="switch-off">TẮT</span>
                                                </span>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="setting-status" id="active-status-card">
                                        <div class="status-indicator active">
                                            <i class="fas fa-check-circle"></i>
                                            <span>Tính năng đang hoạt động</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Live Preview -->
                        <div class="preview-section">
                            <div class="preview-header">
                                <div class="preview-title">
                                    <i class="fas fa-eye"></i>
                                    <span>Xem trước kết quả</span>
                                </div>
                                <div class="preview-badge">
                                    <span class="badge badge-info">Live Preview</span>
                                </div>
                            </div>
                            
                            <div class="preview-grid">
                                <div class="preview-item">
                                    <div class="preview-card" id="footer-preview">
                                        <div class="preview-icon">
                                            <i class="fas fa-desktop"></i>
                                        </div>
                                        <div class="preview-content">
                                            <h6>Website Footer</h6>
                                            <div class="preview-status" id="footer-preview-status">
                                                <i class="fas fa-check-circle text-success"></i>
                                                <span>Bản đồ hiển thị</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="preview-item">
                                    <div class="preview-card" id="system-preview">
                                        <div class="preview-icon">
                                            <i class="fas fa-cogs"></i>
                                        </div>
                                        <div class="preview-content">
                                            <h6>Hệ thống</h6>
                                            <div class="preview-status" id="system-preview-status">
                                                <i class="fas fa-check-circle text-success"></i>
                                                <span>Đang hoạt động</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Hidden fields for form submission -->
                    <input type="hidden" id="latitude" name="latitude" value="{{ location_settings.latitude if location_settings else '' }}">
                    <input type="hidden" id="longitude" name="longitude" value="{{ location_settings.longitude if location_settings else '' }}">
                    <input type="hidden" id="google_maps_api_key" name="google_maps_api_key" value="{{ location_settings.google_maps_api_key if location_settings else '' }}">
                    <input type="hidden" id="google_maps_embed" name="google_maps_embed" value="{{ location_settings.google_maps_embed if location_settings else '' }}">
                    <input type="hidden" id="map_zoom_level" name="map_zoom_level" value="{{ location_settings.map_zoom_level if location_settings else '15' }}">
                    <input type="hidden" id="map_style" name="map_style" value="{{ location_settings.map_style if location_settings else 'roadmap' }}">
                    <input type="hidden" id="map_height" name="map_height" value="{{ location_settings.map_height if location_settings else '400px' }}">

                </div>
                
                    <!-- Step 2: Map Preview -->
                    <div class="section-card">
                        <div class="section-title">
                            <i class="fas fa-map"></i>
                            <div>
                                <h3 class="mb-1">Bước 2: Xem trước bản đồ</h3>
                                <small class="text-muted">Kiểm tra bản đồ trước khi lưu</small>
                            </div>
                            <div class="ml-auto">
                                <div class="status-badge" id="map-status-badge">
                                    <div class="status-dot" id="map-status"></div>
                                    <span id="map-status-text">Chưa có bản đồ</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="map-preview-container">
                            <div id="location-picker-map" class="map-display">
                                <div class="map-placeholder">
                                    <div class="placeholder-icon">
                                        <i class="fas fa-map-marked-alt"></i>
                                    </div>
                                    <h4>Chưa có bản đồ</h4>
                                    <p>Paste code iframe và nhấn "Xem trước bản đồ" để hiển thị</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Form Actions -->
                    <div class="form-actions">
                        <div class="actions-content">
                            <div class="action-info">
                                <h4>Hoàn tất cài đặt</h4>
                                <p>Kiểm tra lại thông tin và lưu cài đặt</p>
                            </div>
                            <div class="action-buttons-footer">
                                <a href="{{ url_for('admin_location') }}" class="btn-secondary-action">
                                    <i class="fas fa-arrow-left"></i>
                                    Quay lại
                                </a>
                                <button type="submit" class="btn-primary-action">
                                    <i class="fas fa-save"></i>
                                    Lưu cài đặt
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
let map;
let marker;
let isMapInitialized = false;

function initLocationPickerMap() {
    // Get current coordinates or use default (Ho Chi Minh City)
    const currentLat = parseFloat(document.getElementById('latitude').value) || 10.7769;
    const currentLng = parseFloat(document.getElementById('longitude').value) || 106.7009;
    const currentApiKey = document.getElementById('google_maps_api_key').value.trim();
    
    // Strict API key validation
    if (!currentApiKey || currentApiKey === '' || currentApiKey === 'None' || currentApiKey === 'null' || currentApiKey === 'undefined') {
        document.getElementById('location-picker-map').innerHTML = 
            '<div class="d-flex align-items-center justify-content-center h-100 bg-light">' +
            '<div class="text-center text-muted">' +
            '<i class="fas fa-map-marked-alt fa-3x mb-3"></i><br>' +
            '<strong>Cần Google Maps API Key</strong><br>' +
            'Vui lòng nhập API Key hợp lệ ở trên để hiển thị bản đồ tương tác<br>' +
            '<small class="text-muted">API Key phải bắt đầu bằng "AIza"</small>' +
            '</div></div>';
        return;
    }
    
    // Basic format validation
    if (!currentApiKey.startsWith('AIza') || currentApiKey.length < 30) {
        document.getElementById('location-picker-map').innerHTML = 
            '<div class="d-flex align-items-center justify-content-center h-100 bg-light">' +
            '<div class="text-center text-muted">' +
            '<i class="fas fa-exclamation-triangle fa-3x mb-3 text-warning"></i><br>' +
            '<strong>API Key không đúng định dạng</strong><br>' +
            'Google Maps API Key phải bắt đầu bằng "AIza"<br>' +
            '<small class="text-muted">Vui lòng kiểm tra lại API Key</small>' +
            '</div></div>';
        return;
    }
    
    try {
        const location = { lat: currentLat, lng: currentLng };
        
        map = new google.maps.Map(document.getElementById("location-picker-map"), {
            zoom: 15,
            center: location,
            mapTypeId: 'roadmap',
            mapId: 'location-picker-map' // Required for AdvancedMarkerElement
        });
        
        // Use AdvancedMarkerElement instead of deprecated Marker
        if (google.maps.marker && google.maps.marker.AdvancedMarkerElement) {
            marker = new google.maps.marker.AdvancedMarkerElement({
                position: location,
                map: map,
                title: 'Kéo thả để điều chỉnh vị trí',
                gmpDraggable: true
            });
            
            // Update coordinates when marker is dragged
            marker.addListener('dragend', function() {
                const position = marker.position;
                updateCoordinates(position.lat, position.lng);
            });
        } else {
            // Fallback to old Marker if AdvancedMarkerElement is not available
            marker = new google.maps.Marker({
                position: location,
                map: map,
                draggable: true,
                title: 'Kéo thả để điều chỉnh vị trí'
            });
            
            // Update coordinates when marker is dragged
            marker.addListener('dragend', function() {
                const position = marker.getPosition();
                updateCoordinates(position.lat(), position.lng());
            });
        }
        
        // Add marker when map is clicked
        map.addListener('click', function(event) {
            const position = event.latLng;
            if (google.maps.marker && google.maps.marker.AdvancedMarkerElement && marker instanceof google.maps.marker.AdvancedMarkerElement) {
                marker.position = { lat: position.lat(), lng: position.lng() };
            } else {
                marker.setPosition(position);
            }
            updateCoordinates(position.lat(), position.lng());
        });
        
        isMapInitialized = true;
        
    } catch (error) {
        console.error('Error initializing map:', error);
        document.getElementById('location-picker-map').innerHTML = 
            '<div class="d-flex align-items-center justify-content-center h-100 bg-light">' +
            '<div class="text-center text-muted">' +
            '<i class="fas fa-exclamation-triangle fa-3x mb-3 text-warning"></i><br>' +
            '<strong>Lỗi khởi tạo bản đồ</strong><br>' +
            'Vui lòng kiểm tra lại API Key hoặc kết nối internet' +
            '</div></div>';
    }
}

function updateCoordinates(lat, lng, skipReverseGeocode = false) {
    document.getElementById('latitude').value = lat.toFixed(6);
    document.getElementById('longitude').value = lng.toFixed(6);
    
    // Add visual feedback
    const latInput = document.getElementById('latitude');
    const lngInput = document.getElementById('longitude');
    
    latInput.style.backgroundColor = '#d4edda';
    lngInput.style.backgroundColor = '#d4edda';
    
    setTimeout(() => {
        latInput.style.backgroundColor = '';
        lngInput.style.backgroundColor = '';
    }, 1000);
    
    // Reverse geocoding to get address (optional)
    if (!skipReverseGeocode && typeof google !== 'undefined') {
        const geocoder = new google.maps.Geocoder();
        const latlng = { lat: lat, lng: lng };
        
        geocoder.geocode({ location: latlng }, function(results, status) {
            if (status === 'OK' && results[0]) {
                const addressField = document.getElementById('address');
                const currentAddress = addressField.value.trim();
                
                // Only update if current address is empty or default
                if (!currentAddress || currentAddress === '123 Đường Hoa Hướng Dương, Quận 1, TP.HCM') {
                    addressField.value = results[0].formatted_address;
                    addressField.style.borderColor = '#17a2b8';
                    setTimeout(() => {
                        addressField.style.borderColor = '';
                    }, 2000);
                }
            }
        });
    }
}

function loadGoogleMapsForPicker() {
    const apiKey = document.getElementById('google_maps_api_key').value.trim();
    
    // Strict API key validation
    if (!apiKey || apiKey === '' || apiKey === 'None' || apiKey === 'null' || apiKey === 'undefined') {
        initLocationPickerMap(); // Show message about needing API key
        return;
    }
    
    // Basic API key format validation (Google API keys start with AIza)
    if (!apiKey.startsWith('AIza') || apiKey.length < 30) {
        document.getElementById('location-picker-map').innerHTML = 
            '<div class="d-flex align-items-center justify-content-center h-100 bg-light">' +
            '<div class="text-center text-muted">' +
            '<i class="fas fa-exclamation-triangle fa-3x mb-3 text-warning"></i><br>' +
            '<strong>API Key không hợp lệ</strong><br>' +
            'Google Maps API Key phải bắt đầu bằng "AIza" và có ít nhất 30 ký tự' +
            '</div></div>';
        return;
    }
    
    if (typeof google === 'undefined') {
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(apiKey)}&libraries=marker&loading=async&callback=initLocationPickerMap`;
        script.async = true;
        script.defer = true;
        script.onerror = function() {
            console.error('Failed to load Google Maps API');
            document.getElementById('location-picker-map').innerHTML = 
                '<div class="d-flex align-items-center justify-content-center h-100 bg-light">' +
                '<div class="text-center text-muted">' +
                '<i class="fas fa-exclamation-triangle fa-3x mb-3 text-danger"></i><br>' +
                '<strong>Không thể tải Google Maps</strong><br>' +
                'Vui lòng kiểm tra API Key và kết nối internet' +
                '</div></div>';
        };
        document.head.appendChild(script);
    } else {
        initLocationPickerMap();
    }
}



// Initialize map when API key is entered
document.getElementById('google_maps_api_key').addEventListener('blur', function() {
    const apiKey = this.value.trim();
    if (apiKey && apiKey !== '' && apiKey !== 'None' && !isMapInitialized) {
        loadGoogleMapsForPicker();
    }
});

// Extract information from Google Maps embed iframe
function extractFromEmbed() {
    const embedCode = document.getElementById('google_maps_embed').value;
    
    if (!embedCode.trim()) {
        alert('Vui lòng paste code iframe từ Google Maps');
        return;
    }
    
    try {
        // Extract src URL from iframe
        const srcMatch = embedCode.match(/src="([^"]+)"/);
        if (!srcMatch) {
            alert('Không tìm thấy URL trong iframe code');
            return;
        }
        
        const url = srcMatch[1];
        console.log('Extracted URL:', url);
        
        // Extract coordinates from pb parameter
        const pbMatch = url.match(/pb=([^&]+)/);
        if (pbMatch) {
            const pbData = decodeURIComponent(pbMatch[1]);
            console.log('PB Data:', pbData);
            
            // Parse pb data to extract coordinates
            // Format: !1m18!1m12!1m3!1d[distance]!2d[lng]!3d[lat]!...
            const coordMatches = pbData.match(/!3d([0-9.-]+)!2d([0-9.-]+)/);
            if (coordMatches) {
                const lat = parseFloat(coordMatches[1]);
                const lng = parseFloat(coordMatches[2]);
                
                console.log('Extracted coordinates:', lat, lng);
                
                if (!isNaN(lat) && !isNaN(lng)) {
                    updateCoordinates(lat, lng, true); // Skip reverse geocoding
                    
                    // Save iframe code to hidden field
                    document.getElementById('google_maps_embed').value = embedCode;
                    
                    // Enable apply button
                    document.getElementById('apply-location').disabled = false;
                    
                    // Show success message
                    const embedField = document.getElementById('google_maps_embed');
                    embedField.style.borderColor = '#28a745';
                    setTimeout(() => {
                        embedField.style.borderColor = '';
                    }, 2000);
                    
                    // Try to extract place name from URL
                    const placeNameMatch = url.match(/!1s0x[^!]+!2s([^!]+)/);
                    if (placeNameMatch) {
                        const placeName = decodeURIComponent(placeNameMatch[1]).replace(/\+/g, ' ');
                        const addressField = document.getElementById('address');
                        if (!addressField.value.trim() || addressField.value === '123 Đường Hoa Hướng Dương, Quận 1, TP.HCM') {
                            addressField.value = placeName;
                        }
                        
                        // Update marker title
                        const markerTitleField = document.getElementById('marker_title');
                        if (!markerTitleField.value.trim() || markerTitleField.value === 'Trường Mầm non Hoa Hướng Dương') {
                            markerTitleField.value = placeName;
                        }
                    }
                    
                    alert(`Đã trích xuất thông tin thành công!\nVĩ độ: ${lat}\nKinh độ: ${lng}\n\nClick "Áp dụng & Hiển thị bản đồ" để xem bản đồ.`);
                    return;
                }
            }
        }
        
        // Alternative method: extract from direct coordinate format
        const directCoordMatch = url.match(/!2d([0-9.-]+)!3d([0-9.-]+)/);
        if (directCoordMatch) {
            const lng = parseFloat(directCoordMatch[1]);
            const lat = parseFloat(directCoordMatch[2]);
            
            if (!isNaN(lat) && !isNaN(lng)) {
                updateCoordinates(lat, lng, true);
                
                // Save iframe code to hidden field
                document.getElementById('google_maps_embed').value = embedCode;
                
                // Enable apply button
                document.getElementById('apply-location').disabled = false;
                
                // Try to extract place name from URL
                const placeNameMatch = url.match(/!1s0x[^!]+!2s([^!]+)/);
                if (placeNameMatch) {
                    const placeName = decodeURIComponent(placeNameMatch[1]).replace(/\+/g, ' ');
                    const addressField = document.getElementById('address');
                    if (!addressField.value.trim() || addressField.value === '123 Đường Hoa Hướng Dương, Quận 1, TP.HCM') {
                        addressField.value = placeName;
                    }
                    
                    const markerTitleField = document.getElementById('marker_title');
                    if (!markerTitleField.value.trim() || markerTitleField.value === 'Trường Mầm non Hoa Hướng Dương') {
                        markerTitleField.value = placeName;
                    }
                }
                
                alert(`Đã trích xuất thông tin thành công!\nVĩ độ: ${lat}\nKinh độ: ${lng}\n\nClick "Áp dụng & Hiển thị bản đồ" để xem bản đồ.`);
                return;
            }
        }
        
        alert('Không thể trích xuất tọa độ từ iframe code này. Vui lòng kiểm tra lại.');
        
    } catch (error) {
        console.error('Error extracting coordinates:', error);
        alert('Có lỗi xảy ra khi trích xuất tọa độ. Vui lòng kiểm tra lại iframe code.');
    }
}

// Apply location and show map
function applyLocation() {
    console.log('🎯 Apply Location button clicked!');
    const lat = parseFloat(document.getElementById('latitude').value);
    const lng = parseFloat(document.getElementById('longitude').value);
    console.log('📍 Coordinates:', lat, lng);
    
    if (isNaN(lat) || isNaN(lng)) {
        alert('Vui lòng trích xuất tọa độ từ iframe trước');
        return;
    }
    
    // Check API Key
    const apiKey = document.getElementById('google_maps_api_key').value.trim();
    if (!apiKey || apiKey === '' || apiKey === 'None' || apiKey === 'null' || apiKey === 'undefined') {
        // Show iframe map instead of interactive map
        const embedCode = document.getElementById('google_maps_embed').value;
        
        if (embedCode.trim()) {
            // Use the iframe from user input
            document.getElementById('location-picker-map').innerHTML = 
                '<div class="border rounded overflow-hidden">' +
                '<div class="bg-primary text-white p-2 small">' +
                '<i class="fas fa-map-marked-alt"></i> Bản đồ từ Google Maps (iframe)' +
                '</div>' +
                '<div style="position: relative; width: 100%; height: 400px;">' +
                embedCode.replace(/width="[^"]*"/g, 'width="100%"').replace(/height="[^"]*"/g, 'height="100%"') +
                '</div>' +
                '</div>';
        } else {
            // Generate iframe URL from coordinates
            const iframeUrl = `https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3000!2d${lng}!3d${lat}!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x0%3A0x0!2zM!5e0!3m2!1sen!2s!4v${Date.now()}!5m2!1sen!2s`;
            
            document.getElementById('location-picker-map').innerHTML = 
                '<div class="border rounded overflow-hidden">' +
                '<div class="bg-success text-white p-2 small">' +
                '<i class="fas fa-map-marked-alt"></i> Bản đồ được tạo từ tọa độ' +
                '</div>' +
                '<div style="position: relative; width: 100%; height: 400px;">' +
                `<iframe src="${iframeUrl}" width="100%" height="100%" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>` +
                '</div>' +
                `<div class="bg-light p-2 small text-muted">` +
                `📍 Vĩ độ: ${lat} | Kinh độ: ${lng}` +
                '</div>' +
                '</div>';
        }
        
        alert('✅ Đã hiển thị bản đồ từ iframe!\n\n' +
              '📍 Tọa độ đã được áp dụng:\n' +
              `• Vĩ độ: ${lat}\n` +
              `• Kinh độ: ${lng}\n\n` +
              '🗺️ Bản đồ hiển thị dưới dạng iframe (không tương tác)\n' +
              '🔑 Để có bản đồ tương tác, vui lòng nhập Google Maps API Key');
        return;
    }
    
    // Basic API key format validation
    if (!apiKey.startsWith('AIza') || apiKey.length < 30) {
        alert('⚠️ Google Maps API Key không hợp lệ!\n\n' +
              '🔑 API Key phải:\n' +
              '• Bắt đầu bằng "AIza"\n' +
              '• Có ít nhất 30 ký tự\n\n' +
              '📍 Tọa độ vẫn đã được áp dụng:\n' +
              `• Vĩ độ: ${lat}\n` +
              `• Kinh độ: ${lng}`);
        
        // Show invalid API key message
        document.getElementById('location-picker-map').innerHTML = 
            '<div class="d-flex align-items-center justify-content-center h-100 bg-light border rounded">' +
            '<div class="text-center text-warning">' +
            '<i class="fas fa-exclamation-triangle fa-3x mb-3"></i><br>' +
            '<strong>⚠️ API Key không hợp lệ</strong><br>' +
            '<div class="mt-2 text-muted small">' +
            'Google Maps API Key phải bắt đầu bằng "AIza" và có ít nhất 30 ký tự' +
            '</div>' +
            `<div class="mt-3 text-success">📍 Tọa độ: ${lat}, ${lng}</div>` +
            '</div></div>';
        return;
    }
    
    // Load and show map with valid API key
    loadGoogleMapsForPicker();
    
    // Show loading message
    document.getElementById('location-picker-map').innerHTML = 
        '<div class="d-flex align-items-center justify-content-center h-100 bg-light border rounded">' +
        '<div class="text-center text-info">' +
        '<i class="fas fa-spinner fa-spin fa-3x mb-3"></i><br>' +
        '<strong>🗺️ Đang tải bản đồ...</strong><br>' +
        `<div class="mt-2">📍 Vĩ độ: ${lat} | Kinh độ: ${lng}</div>` +
        '</div></div>';
}

// Sync iframe code from textarea to hidden field
document.getElementById('google_maps_embed').addEventListener('input', function() {
    // Update hidden field when user types/pastes in textarea
    const hiddenField = document.querySelector('input[name="google_maps_embed"]');
    if (hiddenField) {
        hiddenField.value = this.value;
    }
});

// Add extract from embed button event
document.getElementById('extract-from-embed').addEventListener('click', extractFromEmbed);

// Add apply location button event
document.getElementById('apply-location').addEventListener('click', applyLocation);

// Update marker position when coordinates are manually changed
document.getElementById('latitude').addEventListener('change', function() {
    if (isMapInitialized && marker) {
        const lat = parseFloat(this.value);
        const lng = parseFloat(document.getElementById('longitude').value);
        if (!isNaN(lat) && !isNaN(lng)) {
            const newPosition = { lat: lat, lng: lng };
            if (google.maps.marker && google.maps.marker.AdvancedMarkerElement && marker instanceof google.maps.marker.AdvancedMarkerElement) {
                marker.position = newPosition;
            } else {
                marker.setPosition(newPosition);
            }
            map.setCenter(newPosition);
        }
    }
});

document.getElementById('longitude').addEventListener('change', function() {
    if (isMapInitialized && marker) {
        const lat = parseFloat(document.getElementById('latitude').value);
        const lng = parseFloat(this.value);
        if (!isNaN(lat) && !isNaN(lng)) {
            const newPosition = { lat: lat, lng: lng };
            if (google.maps.marker && google.maps.marker.AdvancedMarkerElement && marker instanceof google.maps.marker.AdvancedMarkerElement) {
                marker.position = newPosition;
            } else {
                marker.setPosition(newPosition);
            }
            map.setCenter(newPosition);
        }
    }
});

// Initialize map on page load - just show placeholder
document.addEventListener('DOMContentLoaded', function() {
    initLocationPickerMap(); // Show message about needing API key or coordinates
    
    // Sync initial iframe code from textarea to hidden field
    const textareaField = document.getElementById('google_maps_embed');
    const hiddenField = document.querySelector('input[name="google_maps_embed"]');
    if (textareaField && hiddenField && textareaField.value) {
        hiddenField.value = textareaField.value;
    }
    
    // Enable apply button if coordinates exist
    const lat = parseFloat(document.getElementById('latitude').value);
    const lng = parseFloat(document.getElementById('longitude').value);
    if (!isNaN(lat) && !isNaN(lng)) {
        document.getElementById('apply-location').disabled = false;
    }
});

// Clear embed button functionality
document.getElementById('clear-embed').addEventListener('click', function() {
    if (confirm('Bạn có chắc muốn xóa code iframe?')) {
        document.getElementById('google_maps_embed').value = '';
        document.getElementById('apply-location').disabled = true;
        updateMapStatus('empty');
        
        // Clear map preview
        const mapContainer = document.getElementById('location-picker-map');
        mapContainer.innerHTML = `
            <div class="map-placeholder">
                <div class="placeholder-icon">
                    <i class="fas fa-map-marked-alt"></i>
                </div>
                <h4>Chưa có bản đồ</h4>
                <p>Paste code iframe và nhấn "Xem trước bản đồ" để hiển thị</p>
            </div>
        `;
    }
});

// Update map status function
function updateMapStatus(status) {
    const statusDot = document.getElementById('map-status');
    const statusText = document.getElementById('map-status-text');
    
    statusDot.className = 'status-dot';
    
    switch(status) {
        case 'ready':
            statusDot.classList.add('active');
            statusText.textContent = 'Sẵn sàng xem trước';
            break;
        case 'invalid':
            statusDot.classList.add('warning');
            statusText.textContent = 'Code không hợp lệ';
            break;
        default:
            statusText.textContent = 'Chưa có bản đồ';
    }
}

// Update map status when embed code is added
document.getElementById('google_maps_embed').addEventListener('input', function() {
    const embedCode = this.value.trim();
    
    if (embedCode.length > 0) {
        if (embedCode.includes('<iframe') && embedCode.includes('google.com/maps')) {
            updateMapStatus('ready');
        } else {
            updateMapStatus('invalid');
        }
    } else {
        updateMapStatus('empty');
    }
});

// Address preview functionality
document.getElementById('address_display').addEventListener('input', function() {
    const addressPreview = document.getElementById('address-preview');
    const newAddress = this.value.trim();
    
    if (newAddress) {
        addressPreview.textContent = newAddress;
        // Also update the hidden address field if it exists
        const hiddenAddressField = document.getElementById('address');
        if (hiddenAddressField) {
            hiddenAddressField.value = newAddress;
        }
    } else {
        addressPreview.textContent = '123 Đường Hoa Hướng Dương, Quận 1, TP.HCM';
    }
});

// Sync marker title and info fields
document.getElementById('marker_title_display').addEventListener('input', function() {
    const hiddenField = document.getElementById('marker_title');
    if (hiddenField) {
        hiddenField.value = this.value;
    }
});

document.getElementById('marker_info_display').addEventListener('input', function() {
    const hiddenField = document.getElementById('marker_info');
    if (hiddenField) {
        hiddenField.value = this.value;
    }
});

// Update preview when toggles change
function updateSettingsPreview() {
    const showInFooter = document.getElementById('show_in_footer_toggle').checked;
    const isActive = document.getElementById('is_active_toggle').checked;
    
    // Update footer setting status
    const footerStatusCard = document.getElementById('footer-status-card');
    const footerIndicator = footerStatusCard.querySelector('.status-indicator');
    
    if (showInFooter) {
        footerIndicator.className = 'status-indicator active';
        footerIndicator.innerHTML = '<i class="fas fa-check-circle"></i><span>Bản đồ sẽ hiển thị trong footer</span>';
    } else {
        footerIndicator.className = 'status-indicator inactive';
        footerIndicator.innerHTML = '<i class="fas fa-times-circle"></i><span>Bản đồ sẽ ẩn khỏi footer</span>';
    }
    
    // Update active setting status
    const activeStatusCard = document.getElementById('active-status-card');
    const activeIndicator = activeStatusCard.querySelector('.status-indicator');
    
    if (isActive) {
        activeIndicator.className = 'status-indicator active';
        activeIndicator.innerHTML = '<i class="fas fa-check-circle"></i><span>Tính năng đang hoạt động</span>';
    } else {
        activeIndicator.className = 'status-indicator inactive';
        activeIndicator.innerHTML = '<i class="fas fa-times-circle"></i><span>Tính năng đã tạm dừng</span>';
    }
    
    // Update live preview section
    const footerPreviewStatus = document.getElementById('footer-preview-status');
    const systemPreviewStatus = document.getElementById('system-preview-status');
    
    if (showInFooter) {
        footerPreviewStatus.innerHTML = '<i class="fas fa-check-circle text-success"></i><span>Bản đồ hiển thị</span>';
    } else {
        footerPreviewStatus.innerHTML = '<i class="fas fa-times-circle text-danger"></i><span>Bản đồ ẩn</span>';
    }
    
    if (isActive) {
        systemPreviewStatus.innerHTML = '<i class="fas fa-check-circle text-success"></i><span>Đang hoạt động</span>';
    } else {
        systemPreviewStatus.innerHTML = '<i class="fas fa-times-circle text-warning"></i><span>Tạm dừng</span>';
    }
}

// Add event listeners for toggles
document.getElementById('show_in_footer_toggle').addEventListener('change', updateSettingsPreview);
document.getElementById('is_active_toggle').addEventListener('change', updateSettingsPreview);

// Initialize preview on page load
document.addEventListener('DOMContentLoaded', function() {
    updateSettingsPreview();
});
</script>

{% endblock %}
