{% extends "admin/base.html" %}

{% block title %}Ch·ªânh s·ª≠a V·ªã tr√≠ & B·∫£n ƒë·ªì{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="text-gradient font-weight-bold mb-2">
                        <i class="fas fa-edit mr-2"></i>
                        Ch·ªânh s·ª≠a V·ªã tr√≠ & B·∫£n ƒë·ªì
                    </h2>
                    <p class="text-muted mb-0">C·∫•u h√¨nh th√¥ng tin ƒë·ªãa ch·ªâ v√† b·∫£n ƒë·ªì Google Maps cho website</p>
                </div>
                <a href="{{ url_for('admin_location') }}" class="btn btn-secondary btn-enhanced">
                    <i class="fas fa-arrow-left"></i> Quay l·∫°i
                </a>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12">
            <form method="POST">
                <!-- Google Maps Configuration Section -->
                <div class="form-section">
                    <h5>
                        <i class="fas fa-map-marked-alt"></i>
                        C√†i ƒë·∫∑t b·∫£n ƒë·ªì t·ª´ Google Maps
                    </h5>
                    <p class="text-muted mb-4">Ch·ªâ c·∫ßn paste code iframe t·ª´ Google Maps ƒë·ªÉ hi·ªÉn th·ªã b·∫£n ƒë·ªì tr√™n website.</p>
                    
                    <div class="form-group">
                        <label for="google_maps_embed" class="font-weight-bold">
                            <i class="fas fa-code mr-2 text-primary"></i>
                            Code nh√∫ng Google Maps (iframe)
                        </label>
                        <textarea class="form-control form-control-enhanced" id="google_maps_embed" rows="6" placeholder='Paste code iframe t·ª´ Google Maps v√†o ƒë√¢y, v√≠ d·ª•: <iframe src="https://www.google.com/maps/embed?pb=..." ...></iframe>'>{{ location_settings.google_maps_embed if location_settings else '' }}</textarea>
                        <div class="mt-3 p-3 bg-light rounded-lg">
                            <h6 class="font-weight-bold text-primary mb-2">
                                <i class="fas fa-info-circle mr-2"></i>
                                C√°ch l·∫•y code iframe:
                            </h6>
                            <ol class="mb-0 text-muted">
                                <li>Truy c·∫≠p <a href="https://www.google.com/maps" target="_blank" class="text-primary">Google Maps</a></li>
                                <li>T√¨m ƒë·ªãa ƒëi·ªÉm c·ªßa b·∫°n</li>
                                <li>Click "Chia s·∫ª" ‚Üí "Nh√∫ng b·∫£n ƒë·ªì"</li>
                                <li>Copy to√†n b·ªô code iframe v√† paste v√†o ƒë√¢y</li>
                            </ol>
                        </div>
                    </div>
                    
                    <div class="d-flex flex-wrap gap-2 mb-4">
                        <button type="button" class="btn btn-enhanced btn-info" id="extract-from-embed">
                            <i class="fas fa-magic"></i> 
                            T·ª± ƒë·ªông l·∫•y th√¥ng tin t·ª´ iframe
                        </button>
                        <button type="button" class="btn btn-enhanced btn-success" id="apply-location" disabled>
                            <i class="fas fa-map"></i> 
                            √Åp d·ª•ng & Hi·ªÉn th·ªã b·∫£n ƒë·ªì
                        </button>
                    </div>
                    
                    <!-- Hidden fields for form submission -->
                    <input type="hidden" id="address" name="address" value="{{ location_settings.address if location_settings else '' }}">
                    <input type="hidden" id="latitude" name="latitude" value="{{ location_settings.latitude if location_settings else '' }}">
                    <input type="hidden" id="longitude" name="longitude" value="{{ location_settings.longitude if location_settings else '' }}">
                    <input type="hidden" id="marker_title" name="marker_title" value="{{ location_settings.marker_title if location_settings else '' }}">
                    <input type="hidden" id="marker_info" name="marker_info" value="{{ location_settings.marker_info if location_settings else '' }}">
                    <input type="hidden" id="google_maps_api_key" name="google_maps_api_key" value="{{ location_settings.google_maps_api_key if location_settings else '' }}">
                    <input type="hidden" id="google_maps_embed" name="google_maps_embed" value="{{ location_settings.google_maps_embed if location_settings else '' }}">
                    <input type="hidden" id="map_zoom_level" name="map_zoom_level" value="{{ location_settings.map_zoom_level if location_settings else '15' }}">
                    <input type="hidden" id="map_style" name="map_style" value="{{ location_settings.map_style if location_settings else 'roadmap' }}">
                    <input type="hidden" id="map_height" name="map_height" value="{{ location_settings.map_height if location_settings else '400px' }}">
                    <input type="hidden" id="show_in_footer" name="show_in_footer" value="{{ 'true' if not location_settings or location_settings.show_in_footer else 'false' }}">
                    <input type="hidden" id="is_active" name="is_active" value="{{ 'true' if not location_settings or location_settings.is_active else 'false' }}">
                </div>
                
                <!-- Map Preview Section -->
                <div class="form-section">
                    <h5>
                        <i class="fas fa-eye"></i>
                        Xem tr∆∞·ªõc b·∫£n ƒë·ªì
                    </h5>
                    <div class="alert-enhanced alert-info mb-4">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-info-circle fa-2x mr-3"></i>
                            <div>
                                <h6 class="font-weight-bold mb-1">H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</h6>
                                <p class="mb-0">Paste code iframe ·ªü tr√™n v√† click "√Åp d·ª•ng & Hi·ªÉn th·ªã b·∫£n ƒë·ªì" ƒë·ªÉ xem b·∫£n ƒë·ªì.</p>
                            </div>
                        </div>
                    </div>
                    <div class="map-container-enhanced">
                        <div id="location-picker-map" style="height: 400px; background: #f8f9fa; display: flex; align-items: center; justify-content: center; color: #6c757d;"></div>
                    </div>
                </div>
                
                <!-- Form Actions -->
                <div class="form-section">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="font-weight-bold text-muted mb-1">S·∫µn s√†ng l∆∞u thay ƒë·ªïi?</h6>
                            <small class="text-muted">Ki·ªÉm tra l·∫°i th√¥ng tin tr∆∞·ªõc khi l∆∞u</small>
                        </div>
                        <div class="d-flex gap-2">
                            <a href="{{ url_for('admin_location') }}" class="btn btn-enhanced btn-secondary">
                                <i class="fas fa-arrow-left"></i> 
                                Quay l·∫°i
                            </a>
                            <button type="submit" class="btn btn-enhanced btn-primary">
                                <i class="fas fa-save"></i> 
                                L∆∞u thay ƒë·ªïi
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let map;
let marker;
let isMapInitialized = false;

function initLocationPickerMap() {
    // Get current coordinates or use default (Ho Chi Minh City)
    const currentLat = parseFloat(document.getElementById('latitude').value) || 10.7769;
    const currentLng = parseFloat(document.getElementById('longitude').value) || 106.7009;
    const currentApiKey = document.getElementById('google_maps_api_key').value.trim();
    
    // Strict API key validation
    if (!currentApiKey || currentApiKey === '' || currentApiKey === 'None' || currentApiKey === 'null' || currentApiKey === 'undefined') {
        document.getElementById('location-picker-map').innerHTML = 
            '<div class="d-flex align-items-center justify-content-center h-100 bg-light">' +
            '<div class="text-center text-muted">' +
            '<i class="fas fa-map-marked-alt fa-3x mb-3"></i><br>' +
            '<strong>C·∫ßn Google Maps API Key</strong><br>' +
            'Vui l√≤ng nh·∫≠p API Key h·ª£p l·ªá ·ªü tr√™n ƒë·ªÉ hi·ªÉn th·ªã b·∫£n ƒë·ªì t∆∞∆°ng t√°c<br>' +
            '<small class="text-muted">API Key ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng "AIza"</small>' +
            '</div></div>';
        return;
    }
    
    // Basic format validation
    if (!currentApiKey.startsWith('AIza') || currentApiKey.length < 30) {
        document.getElementById('location-picker-map').innerHTML = 
            '<div class="d-flex align-items-center justify-content-center h-100 bg-light">' +
            '<div class="text-center text-muted">' +
            '<i class="fas fa-exclamation-triangle fa-3x mb-3 text-warning"></i><br>' +
            '<strong>API Key kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng</strong><br>' +
            'Google Maps API Key ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng "AIza"<br>' +
            '<small class="text-muted">Vui l√≤ng ki·ªÉm tra l·∫°i API Key</small>' +
            '</div></div>';
        return;
    }
    
    try {
        const location = { lat: currentLat, lng: currentLng };
        
        map = new google.maps.Map(document.getElementById("location-picker-map"), {
            zoom: 15,
            center: location,
            mapTypeId: 'roadmap',
            mapId: 'location-picker-map' // Required for AdvancedMarkerElement
        });
        
        // Use AdvancedMarkerElement instead of deprecated Marker
        if (google.maps.marker && google.maps.marker.AdvancedMarkerElement) {
            marker = new google.maps.marker.AdvancedMarkerElement({
                position: location,
                map: map,
                title: 'K√©o th·∫£ ƒë·ªÉ ƒëi·ªÅu ch·ªânh v·ªã tr√≠',
                gmpDraggable: true
            });
            
            // Update coordinates when marker is dragged
            marker.addListener('dragend', function() {
                const position = marker.position;
                updateCoordinates(position.lat, position.lng);
            });
        } else {
            // Fallback to old Marker if AdvancedMarkerElement is not available
            marker = new google.maps.Marker({
                position: location,
                map: map,
                draggable: true,
                title: 'K√©o th·∫£ ƒë·ªÉ ƒëi·ªÅu ch·ªânh v·ªã tr√≠'
            });
            
            // Update coordinates when marker is dragged
            marker.addListener('dragend', function() {
                const position = marker.getPosition();
                updateCoordinates(position.lat(), position.lng());
            });
        }
        
        // Add marker when map is clicked
        map.addListener('click', function(event) {
            const position = event.latLng;
            if (google.maps.marker && google.maps.marker.AdvancedMarkerElement && marker instanceof google.maps.marker.AdvancedMarkerElement) {
                marker.position = { lat: position.lat(), lng: position.lng() };
            } else {
                marker.setPosition(position);
            }
            updateCoordinates(position.lat(), position.lng());
        });
        
        isMapInitialized = true;
        
    } catch (error) {
        console.error('Error initializing map:', error);
        document.getElementById('location-picker-map').innerHTML = 
            '<div class="d-flex align-items-center justify-content-center h-100 bg-light">' +
            '<div class="text-center text-muted">' +
            '<i class="fas fa-exclamation-triangle fa-3x mb-3 text-warning"></i><br>' +
            '<strong>L·ªói kh·ªüi t·∫°o b·∫£n ƒë·ªì</strong><br>' +
            'Vui l√≤ng ki·ªÉm tra l·∫°i API Key ho·∫∑c k·∫øt n·ªëi internet' +
            '</div></div>';
    }
}

function updateCoordinates(lat, lng, skipReverseGeocode = false) {
    document.getElementById('latitude').value = lat.toFixed(6);
    document.getElementById('longitude').value = lng.toFixed(6);
    
    // Add visual feedback
    const latInput = document.getElementById('latitude');
    const lngInput = document.getElementById('longitude');
    
    latInput.style.backgroundColor = '#d4edda';
    lngInput.style.backgroundColor = '#d4edda';
    
    setTimeout(() => {
        latInput.style.backgroundColor = '';
        lngInput.style.backgroundColor = '';
    }, 1000);
    
    // Reverse geocoding to get address (optional)
    if (!skipReverseGeocode && typeof google !== 'undefined') {
        const geocoder = new google.maps.Geocoder();
        const latlng = { lat: lat, lng: lng };
        
        geocoder.geocode({ location: latlng }, function(results, status) {
            if (status === 'OK' && results[0]) {
                const addressField = document.getElementById('address');
                const currentAddress = addressField.value.trim();
                
                // Only update if current address is empty or default
                if (!currentAddress || currentAddress === '123 ƒê∆∞·ªùng Hoa H∆∞·ªõng D∆∞∆°ng, Qu·∫≠n 1, TP.HCM') {
                    addressField.value = results[0].formatted_address;
                    addressField.style.borderColor = '#17a2b8';
                    setTimeout(() => {
                        addressField.style.borderColor = '';
                    }, 2000);
                }
            }
        });
    }
}

function loadGoogleMapsForPicker() {
    const apiKey = document.getElementById('google_maps_api_key').value.trim();
    
    // Strict API key validation
    if (!apiKey || apiKey === '' || apiKey === 'None' || apiKey === 'null' || apiKey === 'undefined') {
        initLocationPickerMap(); // Show message about needing API key
        return;
    }
    
    // Basic API key format validation (Google API keys start with AIza)
    if (!apiKey.startsWith('AIza') || apiKey.length < 30) {
        document.getElementById('location-picker-map').innerHTML = 
            '<div class="d-flex align-items-center justify-content-center h-100 bg-light">' +
            '<div class="text-center text-muted">' +
            '<i class="fas fa-exclamation-triangle fa-3x mb-3 text-warning"></i><br>' +
            '<strong>API Key kh√¥ng h·ª£p l·ªá</strong><br>' +
            'Google Maps API Key ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng "AIza" v√† c√≥ √≠t nh·∫•t 30 k√Ω t·ª±' +
            '</div></div>';
        return;
    }
    
    if (typeof google === 'undefined') {
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(apiKey)}&libraries=marker&loading=async&callback=initLocationPickerMap`;
        script.async = true;
        script.defer = true;
        script.onerror = function() {
            console.error('Failed to load Google Maps API');
            document.getElementById('location-picker-map').innerHTML = 
                '<div class="d-flex align-items-center justify-content-center h-100 bg-light">' +
                '<div class="text-center text-muted">' +
                '<i class="fas fa-exclamation-triangle fa-3x mb-3 text-danger"></i><br>' +
                '<strong>Kh√¥ng th·ªÉ t·∫£i Google Maps</strong><br>' +
                'Vui l√≤ng ki·ªÉm tra API Key v√† k·∫øt n·ªëi internet' +
                '</div></div>';
        };
        document.head.appendChild(script);
    } else {
        initLocationPickerMap();
    }
}



// Initialize map when API key is entered
document.getElementById('google_maps_api_key').addEventListener('blur', function() {
    const apiKey = this.value.trim();
    if (apiKey && apiKey !== '' && apiKey !== 'None' && !isMapInitialized) {
        loadGoogleMapsForPicker();
    }
});

// Extract information from Google Maps embed iframe
function extractFromEmbed() {
    const embedCode = document.getElementById('google_maps_embed').value;
    
    if (!embedCode.trim()) {
        alert('Vui l√≤ng paste code iframe t·ª´ Google Maps');
        return;
    }
    
    try {
        // Extract src URL from iframe
        const srcMatch = embedCode.match(/src="([^"]+)"/);
        if (!srcMatch) {
            alert('Kh√¥ng t√¨m th·∫•y URL trong iframe code');
            return;
        }
        
        const url = srcMatch[1];
        console.log('Extracted URL:', url);
        
        // Extract coordinates from pb parameter
        const pbMatch = url.match(/pb=([^&]+)/);
        if (pbMatch) {
            const pbData = decodeURIComponent(pbMatch[1]);
            console.log('PB Data:', pbData);
            
            // Parse pb data to extract coordinates
            // Format: !1m18!1m12!1m3!1d[distance]!2d[lng]!3d[lat]!...
            const coordMatches = pbData.match(/!3d([0-9.-]+)!2d([0-9.-]+)/);
            if (coordMatches) {
                const lat = parseFloat(coordMatches[1]);
                const lng = parseFloat(coordMatches[2]);
                
                console.log('Extracted coordinates:', lat, lng);
                
                if (!isNaN(lat) && !isNaN(lng)) {
                    updateCoordinates(lat, lng, true); // Skip reverse geocoding
                    
                    // Save iframe code to hidden field
                    document.getElementById('google_maps_embed').value = embedCode;
                    
                    // Enable apply button
                    document.getElementById('apply-location').disabled = false;
                    
                    // Show success message
                    const embedField = document.getElementById('google_maps_embed');
                    embedField.style.borderColor = '#28a745';
                    setTimeout(() => {
                        embedField.style.borderColor = '';
                    }, 2000);
                    
                    // Try to extract place name from URL
                    const placeNameMatch = url.match(/!1s0x[^!]+!2s([^!]+)/);
                    if (placeNameMatch) {
                        const placeName = decodeURIComponent(placeNameMatch[1]).replace(/\+/g, ' ');
                        const addressField = document.getElementById('address');
                        if (!addressField.value.trim() || addressField.value === '123 ƒê∆∞·ªùng Hoa H∆∞·ªõng D∆∞∆°ng, Qu·∫≠n 1, TP.HCM') {
                            addressField.value = placeName;
                        }
                        
                        // Update marker title
                        const markerTitleField = document.getElementById('marker_title');
                        if (!markerTitleField.value.trim() || markerTitleField.value === 'Tr∆∞·ªùng M·∫ßm non Hoa H∆∞·ªõng D∆∞∆°ng') {
                            markerTitleField.value = placeName;
                        }
                    }
                    
                    alert(`ƒê√£ tr√≠ch xu·∫•t th√¥ng tin th√†nh c√¥ng!\nVƒ© ƒë·ªô: ${lat}\nKinh ƒë·ªô: ${lng}\n\nClick "√Åp d·ª•ng & Hi·ªÉn th·ªã b·∫£n ƒë·ªì" ƒë·ªÉ xem b·∫£n ƒë·ªì.`);
                    return;
                }
            }
        }
        
        // Alternative method: extract from direct coordinate format
        const directCoordMatch = url.match(/!2d([0-9.-]+)!3d([0-9.-]+)/);
        if (directCoordMatch) {
            const lng = parseFloat(directCoordMatch[1]);
            const lat = parseFloat(directCoordMatch[2]);
            
            if (!isNaN(lat) && !isNaN(lng)) {
                updateCoordinates(lat, lng, true);
                
                // Save iframe code to hidden field
                document.getElementById('google_maps_embed').value = embedCode;
                
                // Enable apply button
                document.getElementById('apply-location').disabled = false;
                
                // Try to extract place name from URL
                const placeNameMatch = url.match(/!1s0x[^!]+!2s([^!]+)/);
                if (placeNameMatch) {
                    const placeName = decodeURIComponent(placeNameMatch[1]).replace(/\+/g, ' ');
                    const addressField = document.getElementById('address');
                    if (!addressField.value.trim() || addressField.value === '123 ƒê∆∞·ªùng Hoa H∆∞·ªõng D∆∞∆°ng, Qu·∫≠n 1, TP.HCM') {
                        addressField.value = placeName;
                    }
                    
                    const markerTitleField = document.getElementById('marker_title');
                    if (!markerTitleField.value.trim() || markerTitleField.value === 'Tr∆∞·ªùng M·∫ßm non Hoa H∆∞·ªõng D∆∞∆°ng') {
                        markerTitleField.value = placeName;
                    }
                }
                
                alert(`ƒê√£ tr√≠ch xu·∫•t th√¥ng tin th√†nh c√¥ng!\nVƒ© ƒë·ªô: ${lat}\nKinh ƒë·ªô: ${lng}\n\nClick "√Åp d·ª•ng & Hi·ªÉn th·ªã b·∫£n ƒë·ªì" ƒë·ªÉ xem b·∫£n ƒë·ªì.`);
                return;
            }
        }
        
        alert('Kh√¥ng th·ªÉ tr√≠ch xu·∫•t t·ªça ƒë·ªô t·ª´ iframe code n√†y. Vui l√≤ng ki·ªÉm tra l·∫°i.');
        
    } catch (error) {
        console.error('Error extracting coordinates:', error);
        alert('C√≥ l·ªói x·∫£y ra khi tr√≠ch xu·∫•t t·ªça ƒë·ªô. Vui l√≤ng ki·ªÉm tra l·∫°i iframe code.');
    }
}

// Apply location and show map
function applyLocation() {
    console.log('üéØ Apply Location button clicked!');
    const lat = parseFloat(document.getElementById('latitude').value);
    const lng = parseFloat(document.getElementById('longitude').value);
    console.log('üìç Coordinates:', lat, lng);
    
    if (isNaN(lat) || isNaN(lng)) {
        alert('Vui l√≤ng tr√≠ch xu·∫•t t·ªça ƒë·ªô t·ª´ iframe tr∆∞·ªõc');
        return;
    }
    
    // Check API Key
    const apiKey = document.getElementById('google_maps_api_key').value.trim();
    if (!apiKey || apiKey === '' || apiKey === 'None' || apiKey === 'null' || apiKey === 'undefined') {
        // Show iframe map instead of interactive map
        const embedCode = document.getElementById('google_maps_embed').value;
        
        if (embedCode.trim()) {
            // Use the iframe from user input
            document.getElementById('location-picker-map').innerHTML = 
                '<div class="border rounded overflow-hidden">' +
                '<div class="bg-primary text-white p-2 small">' +
                '<i class="fas fa-map-marked-alt"></i> B·∫£n ƒë·ªì t·ª´ Google Maps (iframe)' +
                '</div>' +
                '<div style="position: relative; width: 100%; height: 400px;">' +
                embedCode.replace(/width="[^"]*"/g, 'width="100%"').replace(/height="[^"]*"/g, 'height="100%"') +
                '</div>' +
                '</div>';
        } else {
            // Generate iframe URL from coordinates
            const iframeUrl = `https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3000!2d${lng}!3d${lat}!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x0%3A0x0!2zM!5e0!3m2!1sen!2s!4v${Date.now()}!5m2!1sen!2s`;
            
            document.getElementById('location-picker-map').innerHTML = 
                '<div class="border rounded overflow-hidden">' +
                '<div class="bg-success text-white p-2 small">' +
                '<i class="fas fa-map-marked-alt"></i> B·∫£n ƒë·ªì ƒë∆∞·ª£c t·∫°o t·ª´ t·ªça ƒë·ªô' +
                '</div>' +
                '<div style="position: relative; width: 100%; height: 400px;">' +
                `<iframe src="${iframeUrl}" width="100%" height="100%" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>` +
                '</div>' +
                `<div class="bg-light p-2 small text-muted">` +
                `üìç Vƒ© ƒë·ªô: ${lat} | Kinh ƒë·ªô: ${lng}` +
                '</div>' +
                '</div>';
        }
        
        alert('‚úÖ ƒê√£ hi·ªÉn th·ªã b·∫£n ƒë·ªì t·ª´ iframe!\n\n' +
              'üìç T·ªça ƒë·ªô ƒë√£ ƒë∆∞·ª£c √°p d·ª•ng:\n' +
              `‚Ä¢ Vƒ© ƒë·ªô: ${lat}\n` +
              `‚Ä¢ Kinh ƒë·ªô: ${lng}\n\n` +
              'üó∫Ô∏è B·∫£n ƒë·ªì hi·ªÉn th·ªã d∆∞·ªõi d·∫°ng iframe (kh√¥ng t∆∞∆°ng t√°c)\n' +
              'üîë ƒê·ªÉ c√≥ b·∫£n ƒë·ªì t∆∞∆°ng t√°c, vui l√≤ng nh·∫≠p Google Maps API Key');
        return;
    }
    
    // Basic API key format validation
    if (!apiKey.startsWith('AIza') || apiKey.length < 30) {
        alert('‚ö†Ô∏è Google Maps API Key kh√¥ng h·ª£p l·ªá!\n\n' +
              'üîë API Key ph·∫£i:\n' +
              '‚Ä¢ B·∫Øt ƒë·∫ßu b·∫±ng "AIza"\n' +
              '‚Ä¢ C√≥ √≠t nh·∫•t 30 k√Ω t·ª±\n\n' +
              'üìç T·ªça ƒë·ªô v·∫´n ƒë√£ ƒë∆∞·ª£c √°p d·ª•ng:\n' +
              `‚Ä¢ Vƒ© ƒë·ªô: ${lat}\n` +
              `‚Ä¢ Kinh ƒë·ªô: ${lng}`);
        
        // Show invalid API key message
        document.getElementById('location-picker-map').innerHTML = 
            '<div class="d-flex align-items-center justify-content-center h-100 bg-light border rounded">' +
            '<div class="text-center text-warning">' +
            '<i class="fas fa-exclamation-triangle fa-3x mb-3"></i><br>' +
            '<strong>‚ö†Ô∏è API Key kh√¥ng h·ª£p l·ªá</strong><br>' +
            '<div class="mt-2 text-muted small">' +
            'Google Maps API Key ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng "AIza" v√† c√≥ √≠t nh·∫•t 30 k√Ω t·ª±' +
            '</div>' +
            `<div class="mt-3 text-success">üìç T·ªça ƒë·ªô: ${lat}, ${lng}</div>` +
            '</div></div>';
        return;
    }
    
    // Load and show map with valid API key
    loadGoogleMapsForPicker();
    
    // Show loading message
    document.getElementById('location-picker-map').innerHTML = 
        '<div class="d-flex align-items-center justify-content-center h-100 bg-light border rounded">' +
        '<div class="text-center text-info">' +
        '<i class="fas fa-spinner fa-spin fa-3x mb-3"></i><br>' +
        '<strong>üó∫Ô∏è ƒêang t·∫£i b·∫£n ƒë·ªì...</strong><br>' +
        `<div class="mt-2">üìç Vƒ© ƒë·ªô: ${lat} | Kinh ƒë·ªô: ${lng}</div>` +
        '</div></div>';
}

// Sync iframe code from textarea to hidden field
document.getElementById('google_maps_embed').addEventListener('input', function() {
    // Update hidden field when user types/pastes in textarea
    const hiddenField = document.querySelector('input[name="google_maps_embed"]');
    if (hiddenField) {
        hiddenField.value = this.value;
    }
});

// Add extract from embed button event
document.getElementById('extract-from-embed').addEventListener('click', extractFromEmbed);

// Add apply location button event
document.getElementById('apply-location').addEventListener('click', applyLocation);

// Update marker position when coordinates are manually changed
document.getElementById('latitude').addEventListener('change', function() {
    if (isMapInitialized && marker) {
        const lat = parseFloat(this.value);
        const lng = parseFloat(document.getElementById('longitude').value);
        if (!isNaN(lat) && !isNaN(lng)) {
            const newPosition = { lat: lat, lng: lng };
            if (google.maps.marker && google.maps.marker.AdvancedMarkerElement && marker instanceof google.maps.marker.AdvancedMarkerElement) {
                marker.position = newPosition;
            } else {
                marker.setPosition(newPosition);
            }
            map.setCenter(newPosition);
        }
    }
});

document.getElementById('longitude').addEventListener('change', function() {
    if (isMapInitialized && marker) {
        const lat = parseFloat(document.getElementById('latitude').value);
        const lng = parseFloat(this.value);
        if (!isNaN(lat) && !isNaN(lng)) {
            const newPosition = { lat: lat, lng: lng };
            if (google.maps.marker && google.maps.marker.AdvancedMarkerElement && marker instanceof google.maps.marker.AdvancedMarkerElement) {
                marker.position = newPosition;
            } else {
                marker.setPosition(newPosition);
            }
            map.setCenter(newPosition);
        }
    }
});

// Initialize map on page load - just show placeholder
document.addEventListener('DOMContentLoaded', function() {
    initLocationPickerMap(); // Show message about needing API key or coordinates
    
    // Sync initial iframe code from textarea to hidden field
    const textareaField = document.getElementById('google_maps_embed');
    const hiddenField = document.querySelector('input[name="google_maps_embed"]');
    if (textareaField && hiddenField && textareaField.value) {
        hiddenField.value = textareaField.value;
    }
    
    // Enable apply button if coordinates exist
    const lat = parseFloat(document.getElementById('latitude').value);
    const lng = parseFloat(document.getElementById('longitude').value);
    if (!isNaN(lat) && !isNaN(lng)) {
        document.getElementById('apply-location').disabled = false;
    }
});
</script>

<style>
/* Additional inline styles for edit page */
.text-gradient {
    background: linear-gradient(45deg, #ff6b35, #f7931e);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.gap-2 {
    gap: 0.5rem;
}

.rounded-lg {
    border-radius: 0.5rem;
}

.font-weight-medium {
    font-weight: 500;
}

/* Enhanced button styles for better compatibility */
.btn-enhanced.btn-secondary {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
}

.btn-enhanced.btn-secondary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(108, 117, 125, 0.4);
    color: white;
}

.btn-enhanced.btn-primary {
    background: linear-gradient(45deg, #ff6b35, #f7931e);
    color: white;
    box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
}

.btn-enhanced.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(255, 107, 53, 0.4);
    color: white;
}

/* Form animations */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.form-section {
    animation: fadeInUp 0.6s ease-out;
}

.form-section:nth-child(2) {
    animation-delay: 0.1s;
}

.form-section:nth-child(3) {
    animation-delay: 0.2s;
}

.form-section:nth-child(4) {
    animation-delay: 0.3s;
}

/* Loading state for map */
#location-picker-map:empty::before {
    content: "ƒêang t·∫£i b·∫£n ƒë·ªì...";
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #6c757d;
    font-style: italic;
}

/* Responsive improvements */
@media (max-width: 768px) {
    .d-flex.gap-2 {
        flex-direction: column;
    }
    
    .btn-enhanced {
        width: 100%;
        margin-bottom: 0.5rem;
    }
    
    .form-section {
        padding: 1.5rem;
    }
}
</style>

{% endblock %}
