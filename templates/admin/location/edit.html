{% extends "admin/base.html" %}

{% block title %}C√†i ƒë·∫∑t V·ªã tr√≠ & B·∫£n ƒë·ªì{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
<style>
.location-edit-container {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 2rem 0;
}

.main-card {
    background: white;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.1);
    overflow: hidden;
    margin-bottom: 2rem;
}

.card-header-custom {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem;
    text-align: center;
    position: relative;
}

.card-header-custom::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
    opacity: 0.3;
}

.card-header-custom h1 {
    font-size: 2.5rem;
    font-weight: 700;
    margin: 0;
    position: relative;
    z-index: 1;
}

.card-header-custom p {
    font-size: 1.1rem;
    margin: 0.5rem 0 0 0;
    opacity: 0.9;
    position: relative;
    z-index: 1;
}

.section-card {
    background: white;
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    border: 1px solid #f0f0f0;
    transition: all 0.3s ease;
}

.section-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 40px rgba(0,0,0,0.12);
}

.section-title {
    color: #2d3748;
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
}

.section-title i {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
}

/* Form Elements */
.form-label {
    font-weight: 600;
    color: #2d3748;
    font-size: 1.1rem;
}

.code-input-container {
    position: relative;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
}

.code-textarea {
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 13px;
    line-height: 1.6;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    padding: 1.5rem;
    background: #f8fafc;
    transition: all 0.3s ease;
    resize: vertical;
    min-height: 150px;
}

.code-textarea:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    background: white;
}

.btn-clear {
    position: absolute;
    top: 15px;
    right: 15px;
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 8px;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    opacity: 0.8;
}

.btn-clear:hover {
    opacity: 1;
    transform: scale(1.1);
    background: #dc2626;
}

/* Guide Card */
.guide-card {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border: 1px solid #bae6fd;
    border-radius: 12px;
    padding: 1.5rem;
    margin-top: 1.5rem;
}

.guide-header {
    display: flex;
    align-items: center;
    margin-bottom: 1rem;
    color: #0369a1;
    font-weight: 600;
    font-size: 1.1rem;
}

.guide-header i {
    margin-right: 0.5rem;
    font-size: 1.2rem;
}

.guide-steps {
    display: grid;
    gap: 0.75rem;
}

.step {
    display: flex;
    align-items: center;
    color: #1e40af;
}

.step-number {
    background: #3b82f6;
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.875rem;
    font-weight: 600;
    margin-right: 0.75rem;
    flex-shrink: 0;
}

.step a {
    color: #2563eb;
    text-decoration: none;
    font-weight: 500;
}

.step a:hover {
    text-decoration: underline;
}

/* Action Buttons */
.action-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin-top: 2rem;
}

.btn-action {
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 16px;
    padding: 1.5rem;
    display: flex;
    align-items: center;
    text-align: left;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.btn-action::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    transition: left 0.5s;
}

.btn-action:hover::before {
    left: 100%;
}

.btn-analyze {
    border-color: #3b82f6;
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
}

.btn-analyze:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 40px rgba(59, 130, 246, 0.3);
    border-color: #2563eb;
}

.btn-preview {
    border-color: #10b981;
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
}

.btn-preview:hover:not(:disabled) {
    transform: translateY(-4px);
    box-shadow: 0 12px 40px rgba(16, 185, 129, 0.3);
    border-color: #059669;
}

.btn-preview:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
    border-color: #d1d5db;
}

.btn-icon {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    width: 60px;
    height: 60px;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1.5rem;
    font-size: 1.5rem;
    flex-shrink: 0;
}

.btn-analyze .btn-icon {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
}

.btn-preview .btn-icon {
    background: linear-gradient(135deg, #10b981 0%, #047857 100%);
}

.btn-preview:disabled .btn-icon {
    background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
}

.btn-content h4 {
    margin: 0 0 0.5rem 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: #1f2937;
}

.btn-content p {
    margin: 0;
    color: #6b7280;
    font-size: 0.95rem;
}

/* Status Badge */
.status-badge {
    display: flex;
    align-items: center;
    background: white;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    border: 1px solid #e2e8f0;
    font-size: 0.875rem;
    font-weight: 500;
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #9ca3af;
    margin-right: 0.5rem;
}

.status-dot.active {
    background: #10b981;
}

.status-dot.warning {
    background: #f59e0b;
}

/* Map Preview */
.map-preview-container {
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 8px 32px rgba(0,0,0,0.12);
    margin-top: 1.5rem;
}

.map-display {
    height: 400px;
    width: 100%;
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}

.map-placeholder {
    text-align: center;
    color: #64748b;
}

.placeholder-icon {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    width: 80px;
    height: 80px;
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1.5rem;
    font-size: 2rem;
}

.map-placeholder h4 {
    color: #374151;
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.map-placeholder p {
    color: #6b7280;
    margin: 0;
}

/* Form Actions */
.form-actions {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    border-radius: 16px;
    padding: 2rem;
    margin-top: 2rem;
    border: 1px solid #e2e8f0;
}

.actions-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.action-info h4 {
    color: #1f2937;
    margin: 0 0 0.5rem 0;
    font-weight: 600;
    font-size: 1.25rem;
}

.action-info p {
    color: #6b7280;
    margin: 0;
}

.action-buttons-footer {
    display: flex;
    gap: 1rem;
}

.btn-secondary-action, .btn-primary-action {
    padding: 0.75rem 1.5rem;
    border-radius: 12px;
    font-weight: 600;
    text-decoration: none;
    display: flex;
    align-items: center;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
}

.btn-secondary-action {
    background: #6b7280;
    color: white;
}

.btn-secondary-action:hover {
    background: #4b5563;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(107, 114, 128, 0.3);
    color: white;
    text-decoration: none;
}

.btn-primary-action {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.btn-primary-action:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
}

.btn-secondary-action i, .btn-primary-action i {
    margin-right: 0.5rem;
}

/* Address Input Styling */
.address-input {
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    padding: 1rem 1.5rem;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: #f8fafc;
}

.address-input:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    background: white;
}

.address-preview {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border: 1px solid #bae6fd;
    border-radius: 12px;
    overflow: hidden;
    height: fit-content;
}

.preview-header {
    background: #0369a1;
    color: white;
    padding: 0.75rem 1rem;
    font-size: 0.875rem;
    font-weight: 600;
    display: flex;
    align-items: center;
}

.preview-header i {
    margin-right: 0.5rem;
}

.preview-content {
    padding: 1rem;
}

.address-display {
    color: #1e40af;
    font-weight: 500;
    line-height: 1.5;
    min-height: 1.5rem;
}

/* Form Control Styling */
.form-control {
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    padding: 0.75rem 1rem;
    transition: all 0.3s ease;
    background: #f8fafc;
}

.form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    background: white;
}

/* Responsive Design */
@media (max-width: 768px) {
    .location-edit-container {
        padding: 1rem 0;
    }
    
    .card-header-custom {
        padding: 1.5rem;
    }
    
    .card-header-custom h1 {
        font-size: 2rem;
    }
    
    .section-card {
        padding: 1.5rem;
    }
    
    .action-buttons {
        grid-template-columns: 1fr;
    }
    
    .actions-content {
        flex-direction: column;
        gap: 1.5rem;
        text-align: center;
    }
    
    .action-buttons-footer {
        width: 100%;
        justify-content: center;
    }
    
    .map-display {
        height: 300px;
    }
    
    .address-preview {
        margin-top: 1rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="location-edit-container">
    <div class="container">
        <!-- Main Card -->
        <div class="main-card">
            <!-- Header -->
            <div class="card-header-custom">
                <h1><i class="fas fa-map-marked-alt mr-3"></i>C√†i ƒë·∫∑t V·ªã tr√≠ & B·∫£n ƒë·ªì</h1>
                <p>C·∫•u h√¨nh th√¥ng tin ƒë·ªãa ch·ªâ v√† hi·ªÉn th·ªã b·∫£n ƒë·ªì Google Maps cho website c·ªßa b·∫°n</p>
            </div>
            
            <!-- Content -->
            <div class="p-4">
                <form method="POST">
                    <!-- Step 1: Google Maps Configuration -->
                    <div class="section-card">
                        <div class="section-title">
                            <i class="fas fa-code"></i>
                            <div>
                                <h3 class="mb-1">B∆∞·ªõc 1: Nh√∫ng b·∫£n ƒë·ªì Google Maps</h3>
                                <small class="text-muted">Paste code iframe t·ª´ Google Maps ƒë·ªÉ hi·ªÉn th·ªã b·∫£n ƒë·ªì</small>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="google_maps_embed" class="form-label mb-3">
                                <i class="fas fa-code mr-2"></i>
                                Code iframe t·ª´ Google Maps
                            </label>
                            <div class="code-input-container">
                                <textarea 
                                    class="form-control code-textarea" 
                                    id="google_maps_embed" 
                                    rows="6" 
                                    placeholder='Paste code iframe t·ª´ Google Maps v√†o ƒë√¢y...'
                                >{{ location_settings.google_maps_embed if location_settings else '' }}</textarea>
                                <button type="button" class="btn btn-clear" id="clear-embed" title="X√≥a n·ªôi dung">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Quick Guide -->
                        <div class="guide-card">
                            <div class="guide-header">
                                <i class="fas fa-lightbulb"></i>
                                <span>H∆∞·ªõng d·∫´n l·∫•y code iframe</span>
                            </div>
                            <div class="guide-steps">
                                <div class="step">
                                    <span class="step-number">1</span>
                                    <span>Truy c·∫≠p <a href="https://www.google.com/maps" target="_blank">Google Maps</a></span>
                                </div>
                                <div class="step">
                                    <span class="step-number">2</span>
                                    <span>T√¨m ki·∫øm ƒë·ªãa ƒëi·ªÉm c·ªßa b·∫°n</span>
                                </div>
                                <div class="step">
                                    <span class="step-number">3</span>
                                    <span>Click "Chia s·∫ª" ‚Üí "Nh√∫ng b·∫£n ƒë·ªì"</span>
                                </div>
                                <div class="step">
                                    <span class="step-number">4</span>
                                    <span>Copy to√†n b·ªô code iframe</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="action-buttons">
                            <button type="button" class="btn-action btn-analyze" id="extract-from-embed">
                                <div class="btn-icon">
                                    <i class="fas fa-magic"></i>
                                </div>
                                <div class="btn-content">
                                    <h4>T·ª± ƒë·ªông ph√¢n t√≠ch</h4>
                                    <p>Tr√≠ch xu·∫•t th√¥ng tin t·ª´ code iframe</p>
                                </div>
                            </button>
                            
                            <button type="button" class="btn-action btn-preview" id="apply-location" disabled>
                                <div class="btn-icon">
                                    <i class="fas fa-eye"></i>
                                </div>
                                <div class="btn-content">
                                    <h4>Xem tr∆∞·ªõc b·∫£n ƒë·ªì</h4>
                                    <p>Hi·ªÉn th·ªã b·∫£n ƒë·ªì ·ªü b√™n d∆∞·ªõi</p>
                                </div>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Step 1.5: Address Information -->
                    <div class="section-card">
                        <div class="section-title">
                            <i class="fas fa-home"></i>
                            <div>
                                <h3 class="mb-1">Th√¥ng tin ƒë·ªãa ch·ªâ</h3>
                                <small class="text-muted">C·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ hi·ªÉn th·ªã tr√™n website</small>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-8">
                                <div class="form-group">
                                    <label for="address_display" class="form-label mb-3">
                                        <i class="fas fa-map-marker-alt mr-2"></i>
                                        ƒê·ªãa ch·ªâ hi·ªÉn th·ªã
                                    </label>
                                    <input 
                                        type="text" 
                                        class="form-control address-input" 
                                        id="address_display" 
                                        name="address"
                                        value="{{ location_settings.address if location_settings else '123 ƒê∆∞·ªùng Hoa H∆∞·ªõng D∆∞∆°ng, Qu·∫≠n 1, TP.HCM' }}"
                                        placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ƒë·∫ßy ƒë·ªß c·ªßa tr∆∞·ªùng..."
                                    >
                                    <small class="form-text text-muted mt-2">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        ƒê·ªãa ch·ªâ n√†y s·∫Ω hi·ªÉn th·ªã tr√™n website v√† trong th√¥ng tin li√™n h·ªá
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="address-preview">
                                    <div class="preview-header">
                                        <i class="fas fa-eye"></i>
                                        <span>Xem tr∆∞·ªõc</span>
                                    </div>
                                    <div class="preview-content">
                                        <div class="address-display" id="address-preview">
                                            {{ location_settings.address if location_settings else '123 ƒê∆∞·ªùng Hoa H∆∞·ªõng D∆∞∆°ng, Qu·∫≠n 1, TP.HCM' }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="marker_title_display" class="form-label">
                                        <i class="fas fa-tag mr-2"></i>
                                        Ti√™u ƒë·ªÅ marker
                                    </label>
                                    <input 
                                        type="text" 
                                        class="form-control" 
                                        id="marker_title_display" 
                                        name="marker_title"
                                        value="{{ location_settings.marker_title if location_settings else 'Tr∆∞·ªùng M·∫ßm non Hoa H∆∞·ªõng D∆∞∆°ng' }}"
                                        placeholder="Ti√™u ƒë·ªÅ hi·ªÉn th·ªã tr√™n b·∫£n ƒë·ªì..."
                                    >
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="marker_info_display" class="form-label">
                                        <i class="fas fa-info-circle mr-2"></i>
                                        Th√¥ng tin marker
                                    </label>
                                    <input 
                                        type="text" 
                                        class="form-control" 
                                        id="marker_info_display" 
                                        name="marker_info"
                                        value="{{ location_settings.marker_info if location_settings else 'Tr∆∞·ªùng M·∫ßm non Hoa H∆∞·ªõng D∆∞∆°ng - Nu√¥i d∆∞·ª°ng t√¢m h·ªìn, ph√°t tri·ªÉn t√†i nƒÉng' }}"
                                        placeholder="M√¥ t·∫£ chi ti·∫øt..."
                                    >
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Hidden fields for form submission -->
                    <input type="hidden" id="latitude" name="latitude" value="{{ location_settings.latitude if location_settings else '' }}">
                    <input type="hidden" id="longitude" name="longitude" value="{{ location_settings.longitude if location_settings else '' }}">
                    <input type="hidden" id="google_maps_api_key" name="google_maps_api_key" value="{{ location_settings.google_maps_api_key if location_settings else '' }}">
                    <input type="hidden" id="google_maps_embed" name="google_maps_embed" value="{{ location_settings.google_maps_embed if location_settings else '' }}">
                    <input type="hidden" id="map_zoom_level" name="map_zoom_level" value="{{ location_settings.map_zoom_level if location_settings else '15' }}">
                    <input type="hidden" id="map_style" name="map_style" value="{{ location_settings.map_style if location_settings else 'roadmap' }}">
                    <input type="hidden" id="map_height" name="map_height" value="{{ location_settings.map_height if location_settings else '400px' }}">
                    <input type="hidden" id="show_in_footer" name="show_in_footer" value="{{ 'true' if not location_settings or location_settings.show_in_footer else 'false' }}">
                    <input type="hidden" id="is_active" name="is_active" value="{{ 'true' if not location_settings or location_settings.is_active else 'false' }}">
                </div>
                
                    <!-- Step 2: Map Preview -->
                    <div class="section-card">
                        <div class="section-title">
                            <i class="fas fa-map"></i>
                            <div>
                                <h3 class="mb-1">B∆∞·ªõc 2: Xem tr∆∞·ªõc b·∫£n ƒë·ªì</h3>
                                <small class="text-muted">Ki·ªÉm tra b·∫£n ƒë·ªì tr∆∞·ªõc khi l∆∞u</small>
                            </div>
                            <div class="ml-auto">
                                <div class="status-badge" id="map-status-badge">
                                    <div class="status-dot" id="map-status"></div>
                                    <span id="map-status-text">Ch∆∞a c√≥ b·∫£n ƒë·ªì</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="map-preview-container">
                            <div id="location-picker-map" class="map-display">
                                <div class="map-placeholder">
                                    <div class="placeholder-icon">
                                        <i class="fas fa-map-marked-alt"></i>
                                    </div>
                                    <h4>Ch∆∞a c√≥ b·∫£n ƒë·ªì</h4>
                                    <p>Paste code iframe v√† nh·∫•n "Xem tr∆∞·ªõc b·∫£n ƒë·ªì" ƒë·ªÉ hi·ªÉn th·ªã</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Form Actions -->
                    <div class="form-actions">
                        <div class="actions-content">
                            <div class="action-info">
                                <h4>Ho√†n t·∫•t c√†i ƒë·∫∑t</h4>
                                <p>Ki·ªÉm tra l·∫°i th√¥ng tin v√† l∆∞u c√†i ƒë·∫∑t</p>
                            </div>
                            <div class="action-buttons-footer">
                                <a href="{{ url_for('admin_location') }}" class="btn-secondary-action">
                                    <i class="fas fa-arrow-left"></i>
                                    Quay l·∫°i
                                </a>
                                <button type="submit" class="btn-primary-action">
                                    <i class="fas fa-save"></i>
                                    L∆∞u c√†i ƒë·∫∑t
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
let map;
let marker;
let isMapInitialized = false;

function initLocationPickerMap() {
    // Get current coordinates or use default (Ho Chi Minh City)
    const currentLat = parseFloat(document.getElementById('latitude').value) || 10.7769;
    const currentLng = parseFloat(document.getElementById('longitude').value) || 106.7009;
    const currentApiKey = document.getElementById('google_maps_api_key').value.trim();
    
    // Strict API key validation
    if (!currentApiKey || currentApiKey === '' || currentApiKey === 'None' || currentApiKey === 'null' || currentApiKey === 'undefined') {
        document.getElementById('location-picker-map').innerHTML = 
            '<div class="d-flex align-items-center justify-content-center h-100 bg-light">' +
            '<div class="text-center text-muted">' +
            '<i class="fas fa-map-marked-alt fa-3x mb-3"></i><br>' +
            '<strong>C·∫ßn Google Maps API Key</strong><br>' +
            'Vui l√≤ng nh·∫≠p API Key h·ª£p l·ªá ·ªü tr√™n ƒë·ªÉ hi·ªÉn th·ªã b·∫£n ƒë·ªì t∆∞∆°ng t√°c<br>' +
            '<small class="text-muted">API Key ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng "AIza"</small>' +
            '</div></div>';
        return;
    }
    
    // Basic format validation
    if (!currentApiKey.startsWith('AIza') || currentApiKey.length < 30) {
        document.getElementById('location-picker-map').innerHTML = 
            '<div class="d-flex align-items-center justify-content-center h-100 bg-light">' +
            '<div class="text-center text-muted">' +
            '<i class="fas fa-exclamation-triangle fa-3x mb-3 text-warning"></i><br>' +
            '<strong>API Key kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng</strong><br>' +
            'Google Maps API Key ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng "AIza"<br>' +
            '<small class="text-muted">Vui l√≤ng ki·ªÉm tra l·∫°i API Key</small>' +
            '</div></div>';
        return;
    }
    
    try {
        const location = { lat: currentLat, lng: currentLng };
        
        map = new google.maps.Map(document.getElementById("location-picker-map"), {
            zoom: 15,
            center: location,
            mapTypeId: 'roadmap',
            mapId: 'location-picker-map' // Required for AdvancedMarkerElement
        });
        
        // Use AdvancedMarkerElement instead of deprecated Marker
        if (google.maps.marker && google.maps.marker.AdvancedMarkerElement) {
            marker = new google.maps.marker.AdvancedMarkerElement({
                position: location,
                map: map,
                title: 'K√©o th·∫£ ƒë·ªÉ ƒëi·ªÅu ch·ªânh v·ªã tr√≠',
                gmpDraggable: true
            });
            
            // Update coordinates when marker is dragged
            marker.addListener('dragend', function() {
                const position = marker.position;
                updateCoordinates(position.lat, position.lng);
            });
        } else {
            // Fallback to old Marker if AdvancedMarkerElement is not available
            marker = new google.maps.Marker({
                position: location,
                map: map,
                draggable: true,
                title: 'K√©o th·∫£ ƒë·ªÉ ƒëi·ªÅu ch·ªânh v·ªã tr√≠'
            });
            
            // Update coordinates when marker is dragged
            marker.addListener('dragend', function() {
                const position = marker.getPosition();
                updateCoordinates(position.lat(), position.lng());
            });
        }
        
        // Add marker when map is clicked
        map.addListener('click', function(event) {
            const position = event.latLng;
            if (google.maps.marker && google.maps.marker.AdvancedMarkerElement && marker instanceof google.maps.marker.AdvancedMarkerElement) {
                marker.position = { lat: position.lat(), lng: position.lng() };
            } else {
                marker.setPosition(position);
            }
            updateCoordinates(position.lat(), position.lng());
        });
        
        isMapInitialized = true;
        
    } catch (error) {
        console.error('Error initializing map:', error);
        document.getElementById('location-picker-map').innerHTML = 
            '<div class="d-flex align-items-center justify-content-center h-100 bg-light">' +
            '<div class="text-center text-muted">' +
            '<i class="fas fa-exclamation-triangle fa-3x mb-3 text-warning"></i><br>' +
            '<strong>L·ªói kh·ªüi t·∫°o b·∫£n ƒë·ªì</strong><br>' +
            'Vui l√≤ng ki·ªÉm tra l·∫°i API Key ho·∫∑c k·∫øt n·ªëi internet' +
            '</div></div>';
    }
}

function updateCoordinates(lat, lng, skipReverseGeocode = false) {
    document.getElementById('latitude').value = lat.toFixed(6);
    document.getElementById('longitude').value = lng.toFixed(6);
    
    // Add visual feedback
    const latInput = document.getElementById('latitude');
    const lngInput = document.getElementById('longitude');
    
    latInput.style.backgroundColor = '#d4edda';
    lngInput.style.backgroundColor = '#d4edda';
    
    setTimeout(() => {
        latInput.style.backgroundColor = '';
        lngInput.style.backgroundColor = '';
    }, 1000);
    
    // Reverse geocoding to get address (optional)
    if (!skipReverseGeocode && typeof google !== 'undefined') {
        const geocoder = new google.maps.Geocoder();
        const latlng = { lat: lat, lng: lng };
        
        geocoder.geocode({ location: latlng }, function(results, status) {
            if (status === 'OK' && results[0]) {
                const addressField = document.getElementById('address');
                const currentAddress = addressField.value.trim();
                
                // Only update if current address is empty or default
                if (!currentAddress || currentAddress === '123 ƒê∆∞·ªùng Hoa H∆∞·ªõng D∆∞∆°ng, Qu·∫≠n 1, TP.HCM') {
                    addressField.value = results[0].formatted_address;
                    addressField.style.borderColor = '#17a2b8';
                    setTimeout(() => {
                        addressField.style.borderColor = '';
                    }, 2000);
                }
            }
        });
    }
}

function loadGoogleMapsForPicker() {
    const apiKey = document.getElementById('google_maps_api_key').value.trim();
    
    // Strict API key validation
    if (!apiKey || apiKey === '' || apiKey === 'None' || apiKey === 'null' || apiKey === 'undefined') {
        initLocationPickerMap(); // Show message about needing API key
        return;
    }
    
    // Basic API key format validation (Google API keys start with AIza)
    if (!apiKey.startsWith('AIza') || apiKey.length < 30) {
        document.getElementById('location-picker-map').innerHTML = 
            '<div class="d-flex align-items-center justify-content-center h-100 bg-light">' +
            '<div class="text-center text-muted">' +
            '<i class="fas fa-exclamation-triangle fa-3x mb-3 text-warning"></i><br>' +
            '<strong>API Key kh√¥ng h·ª£p l·ªá</strong><br>' +
            'Google Maps API Key ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng "AIza" v√† c√≥ √≠t nh·∫•t 30 k√Ω t·ª±' +
            '</div></div>';
        return;
    }
    
    if (typeof google === 'undefined') {
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(apiKey)}&libraries=marker&loading=async&callback=initLocationPickerMap`;
        script.async = true;
        script.defer = true;
        script.onerror = function() {
            console.error('Failed to load Google Maps API');
            document.getElementById('location-picker-map').innerHTML = 
                '<div class="d-flex align-items-center justify-content-center h-100 bg-light">' +
                '<div class="text-center text-muted">' +
                '<i class="fas fa-exclamation-triangle fa-3x mb-3 text-danger"></i><br>' +
                '<strong>Kh√¥ng th·ªÉ t·∫£i Google Maps</strong><br>' +
                'Vui l√≤ng ki·ªÉm tra API Key v√† k·∫øt n·ªëi internet' +
                '</div></div>';
        };
        document.head.appendChild(script);
    } else {
        initLocationPickerMap();
    }
}



// Initialize map when API key is entered
document.getElementById('google_maps_api_key').addEventListener('blur', function() {
    const apiKey = this.value.trim();
    if (apiKey && apiKey !== '' && apiKey !== 'None' && !isMapInitialized) {
        loadGoogleMapsForPicker();
    }
});

// Extract information from Google Maps embed iframe
function extractFromEmbed() {
    const embedCode = document.getElementById('google_maps_embed').value;
    
    if (!embedCode.trim()) {
        alert('Vui l√≤ng paste code iframe t·ª´ Google Maps');
        return;
    }
    
    try {
        // Extract src URL from iframe
        const srcMatch = embedCode.match(/src="([^"]+)"/);
        if (!srcMatch) {
            alert('Kh√¥ng t√¨m th·∫•y URL trong iframe code');
            return;
        }
        
        const url = srcMatch[1];
        console.log('Extracted URL:', url);
        
        // Extract coordinates from pb parameter
        const pbMatch = url.match(/pb=([^&]+)/);
        if (pbMatch) {
            const pbData = decodeURIComponent(pbMatch[1]);
            console.log('PB Data:', pbData);
            
            // Parse pb data to extract coordinates
            // Format: !1m18!1m12!1m3!1d[distance]!2d[lng]!3d[lat]!...
            const coordMatches = pbData.match(/!3d([0-9.-]+)!2d([0-9.-]+)/);
            if (coordMatches) {
                const lat = parseFloat(coordMatches[1]);
                const lng = parseFloat(coordMatches[2]);
                
                console.log('Extracted coordinates:', lat, lng);
                
                if (!isNaN(lat) && !isNaN(lng)) {
                    updateCoordinates(lat, lng, true); // Skip reverse geocoding
                    
                    // Save iframe code to hidden field
                    document.getElementById('google_maps_embed').value = embedCode;
                    
                    // Enable apply button
                    document.getElementById('apply-location').disabled = false;
                    
                    // Show success message
                    const embedField = document.getElementById('google_maps_embed');
                    embedField.style.borderColor = '#28a745';
                    setTimeout(() => {
                        embedField.style.borderColor = '';
                    }, 2000);
                    
                    // Try to extract place name from URL
                    const placeNameMatch = url.match(/!1s0x[^!]+!2s([^!]+)/);
                    if (placeNameMatch) {
                        const placeName = decodeURIComponent(placeNameMatch[1]).replace(/\+/g, ' ');
                        const addressField = document.getElementById('address');
                        if (!addressField.value.trim() || addressField.value === '123 ƒê∆∞·ªùng Hoa H∆∞·ªõng D∆∞∆°ng, Qu·∫≠n 1, TP.HCM') {
                            addressField.value = placeName;
                        }
                        
                        // Update marker title
                        const markerTitleField = document.getElementById('marker_title');
                        if (!markerTitleField.value.trim() || markerTitleField.value === 'Tr∆∞·ªùng M·∫ßm non Hoa H∆∞·ªõng D∆∞∆°ng') {
                            markerTitleField.value = placeName;
                        }
                    }
                    
                    alert(`ƒê√£ tr√≠ch xu·∫•t th√¥ng tin th√†nh c√¥ng!\nVƒ© ƒë·ªô: ${lat}\nKinh ƒë·ªô: ${lng}\n\nClick "√Åp d·ª•ng & Hi·ªÉn th·ªã b·∫£n ƒë·ªì" ƒë·ªÉ xem b·∫£n ƒë·ªì.`);
                    return;
                }
            }
        }
        
        // Alternative method: extract from direct coordinate format
        const directCoordMatch = url.match(/!2d([0-9.-]+)!3d([0-9.-]+)/);
        if (directCoordMatch) {
            const lng = parseFloat(directCoordMatch[1]);
            const lat = parseFloat(directCoordMatch[2]);
            
            if (!isNaN(lat) && !isNaN(lng)) {
                updateCoordinates(lat, lng, true);
                
                // Save iframe code to hidden field
                document.getElementById('google_maps_embed').value = embedCode;
                
                // Enable apply button
                document.getElementById('apply-location').disabled = false;
                
                // Try to extract place name from URL
                const placeNameMatch = url.match(/!1s0x[^!]+!2s([^!]+)/);
                if (placeNameMatch) {
                    const placeName = decodeURIComponent(placeNameMatch[1]).replace(/\+/g, ' ');
                    const addressField = document.getElementById('address');
                    if (!addressField.value.trim() || addressField.value === '123 ƒê∆∞·ªùng Hoa H∆∞·ªõng D∆∞∆°ng, Qu·∫≠n 1, TP.HCM') {
                        addressField.value = placeName;
                    }
                    
                    const markerTitleField = document.getElementById('marker_title');
                    if (!markerTitleField.value.trim() || markerTitleField.value === 'Tr∆∞·ªùng M·∫ßm non Hoa H∆∞·ªõng D∆∞∆°ng') {
                        markerTitleField.value = placeName;
                    }
                }
                
                alert(`ƒê√£ tr√≠ch xu·∫•t th√¥ng tin th√†nh c√¥ng!\nVƒ© ƒë·ªô: ${lat}\nKinh ƒë·ªô: ${lng}\n\nClick "√Åp d·ª•ng & Hi·ªÉn th·ªã b·∫£n ƒë·ªì" ƒë·ªÉ xem b·∫£n ƒë·ªì.`);
                return;
            }
        }
        
        alert('Kh√¥ng th·ªÉ tr√≠ch xu·∫•t t·ªça ƒë·ªô t·ª´ iframe code n√†y. Vui l√≤ng ki·ªÉm tra l·∫°i.');
        
    } catch (error) {
        console.error('Error extracting coordinates:', error);
        alert('C√≥ l·ªói x·∫£y ra khi tr√≠ch xu·∫•t t·ªça ƒë·ªô. Vui l√≤ng ki·ªÉm tra l·∫°i iframe code.');
    }
}

// Apply location and show map
function applyLocation() {
    console.log('üéØ Apply Location button clicked!');
    const lat = parseFloat(document.getElementById('latitude').value);
    const lng = parseFloat(document.getElementById('longitude').value);
    console.log('üìç Coordinates:', lat, lng);
    
    if (isNaN(lat) || isNaN(lng)) {
        alert('Vui l√≤ng tr√≠ch xu·∫•t t·ªça ƒë·ªô t·ª´ iframe tr∆∞·ªõc');
        return;
    }
    
    // Check API Key
    const apiKey = document.getElementById('google_maps_api_key').value.trim();
    if (!apiKey || apiKey === '' || apiKey === 'None' || apiKey === 'null' || apiKey === 'undefined') {
        // Show iframe map instead of interactive map
        const embedCode = document.getElementById('google_maps_embed').value;
        
        if (embedCode.trim()) {
            // Use the iframe from user input
            document.getElementById('location-picker-map').innerHTML = 
                '<div class="border rounded overflow-hidden">' +
                '<div class="bg-primary text-white p-2 small">' +
                '<i class="fas fa-map-marked-alt"></i> B·∫£n ƒë·ªì t·ª´ Google Maps (iframe)' +
                '</div>' +
                '<div style="position: relative; width: 100%; height: 400px;">' +
                embedCode.replace(/width="[^"]*"/g, 'width="100%"').replace(/height="[^"]*"/g, 'height="100%"') +
                '</div>' +
                '</div>';
        } else {
            // Generate iframe URL from coordinates
            const iframeUrl = `https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3000!2d${lng}!3d${lat}!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x0%3A0x0!2zM!5e0!3m2!1sen!2s!4v${Date.now()}!5m2!1sen!2s`;
            
            document.getElementById('location-picker-map').innerHTML = 
                '<div class="border rounded overflow-hidden">' +
                '<div class="bg-success text-white p-2 small">' +
                '<i class="fas fa-map-marked-alt"></i> B·∫£n ƒë·ªì ƒë∆∞·ª£c t·∫°o t·ª´ t·ªça ƒë·ªô' +
                '</div>' +
                '<div style="position: relative; width: 100%; height: 400px;">' +
                `<iframe src="${iframeUrl}" width="100%" height="100%" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>` +
                '</div>' +
                `<div class="bg-light p-2 small text-muted">` +
                `üìç Vƒ© ƒë·ªô: ${lat} | Kinh ƒë·ªô: ${lng}` +
                '</div>' +
                '</div>';
        }
        
        alert('‚úÖ ƒê√£ hi·ªÉn th·ªã b·∫£n ƒë·ªì t·ª´ iframe!\n\n' +
              'üìç T·ªça ƒë·ªô ƒë√£ ƒë∆∞·ª£c √°p d·ª•ng:\n' +
              `‚Ä¢ Vƒ© ƒë·ªô: ${lat}\n` +
              `‚Ä¢ Kinh ƒë·ªô: ${lng}\n\n` +
              'üó∫Ô∏è B·∫£n ƒë·ªì hi·ªÉn th·ªã d∆∞·ªõi d·∫°ng iframe (kh√¥ng t∆∞∆°ng t√°c)\n' +
              'üîë ƒê·ªÉ c√≥ b·∫£n ƒë·ªì t∆∞∆°ng t√°c, vui l√≤ng nh·∫≠p Google Maps API Key');
        return;
    }
    
    // Basic API key format validation
    if (!apiKey.startsWith('AIza') || apiKey.length < 30) {
        alert('‚ö†Ô∏è Google Maps API Key kh√¥ng h·ª£p l·ªá!\n\n' +
              'üîë API Key ph·∫£i:\n' +
              '‚Ä¢ B·∫Øt ƒë·∫ßu b·∫±ng "AIza"\n' +
              '‚Ä¢ C√≥ √≠t nh·∫•t 30 k√Ω t·ª±\n\n' +
              'üìç T·ªça ƒë·ªô v·∫´n ƒë√£ ƒë∆∞·ª£c √°p d·ª•ng:\n' +
              `‚Ä¢ Vƒ© ƒë·ªô: ${lat}\n` +
              `‚Ä¢ Kinh ƒë·ªô: ${lng}`);
        
        // Show invalid API key message
        document.getElementById('location-picker-map').innerHTML = 
            '<div class="d-flex align-items-center justify-content-center h-100 bg-light border rounded">' +
            '<div class="text-center text-warning">' +
            '<i class="fas fa-exclamation-triangle fa-3x mb-3"></i><br>' +
            '<strong>‚ö†Ô∏è API Key kh√¥ng h·ª£p l·ªá</strong><br>' +
            '<div class="mt-2 text-muted small">' +
            'Google Maps API Key ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng "AIza" v√† c√≥ √≠t nh·∫•t 30 k√Ω t·ª±' +
            '</div>' +
            `<div class="mt-3 text-success">üìç T·ªça ƒë·ªô: ${lat}, ${lng}</div>` +
            '</div></div>';
        return;
    }
    
    // Load and show map with valid API key
    loadGoogleMapsForPicker();
    
    // Show loading message
    document.getElementById('location-picker-map').innerHTML = 
        '<div class="d-flex align-items-center justify-content-center h-100 bg-light border rounded">' +
        '<div class="text-center text-info">' +
        '<i class="fas fa-spinner fa-spin fa-3x mb-3"></i><br>' +
        '<strong>üó∫Ô∏è ƒêang t·∫£i b·∫£n ƒë·ªì...</strong><br>' +
        `<div class="mt-2">üìç Vƒ© ƒë·ªô: ${lat} | Kinh ƒë·ªô: ${lng}</div>` +
        '</div></div>';
}

// Sync iframe code from textarea to hidden field
document.getElementById('google_maps_embed').addEventListener('input', function() {
    // Update hidden field when user types/pastes in textarea
    const hiddenField = document.querySelector('input[name="google_maps_embed"]');
    if (hiddenField) {
        hiddenField.value = this.value;
    }
});

// Add extract from embed button event
document.getElementById('extract-from-embed').addEventListener('click', extractFromEmbed);

// Add apply location button event
document.getElementById('apply-location').addEventListener('click', applyLocation);

// Update marker position when coordinates are manually changed
document.getElementById('latitude').addEventListener('change', function() {
    if (isMapInitialized && marker) {
        const lat = parseFloat(this.value);
        const lng = parseFloat(document.getElementById('longitude').value);
        if (!isNaN(lat) && !isNaN(lng)) {
            const newPosition = { lat: lat, lng: lng };
            if (google.maps.marker && google.maps.marker.AdvancedMarkerElement && marker instanceof google.maps.marker.AdvancedMarkerElement) {
                marker.position = newPosition;
            } else {
                marker.setPosition(newPosition);
            }
            map.setCenter(newPosition);
        }
    }
});

document.getElementById('longitude').addEventListener('change', function() {
    if (isMapInitialized && marker) {
        const lat = parseFloat(document.getElementById('latitude').value);
        const lng = parseFloat(this.value);
        if (!isNaN(lat) && !isNaN(lng)) {
            const newPosition = { lat: lat, lng: lng };
            if (google.maps.marker && google.maps.marker.AdvancedMarkerElement && marker instanceof google.maps.marker.AdvancedMarkerElement) {
                marker.position = newPosition;
            } else {
                marker.setPosition(newPosition);
            }
            map.setCenter(newPosition);
        }
    }
});

// Initialize map on page load - just show placeholder
document.addEventListener('DOMContentLoaded', function() {
    initLocationPickerMap(); // Show message about needing API key or coordinates
    
    // Sync initial iframe code from textarea to hidden field
    const textareaField = document.getElementById('google_maps_embed');
    const hiddenField = document.querySelector('input[name="google_maps_embed"]');
    if (textareaField && hiddenField && textareaField.value) {
        hiddenField.value = textareaField.value;
    }
    
    // Enable apply button if coordinates exist
    const lat = parseFloat(document.getElementById('latitude').value);
    const lng = parseFloat(document.getElementById('longitude').value);
    if (!isNaN(lat) && !isNaN(lng)) {
        document.getElementById('apply-location').disabled = false;
    }
});

// Clear embed button functionality
document.getElementById('clear-embed').addEventListener('click', function() {
    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a code iframe?')) {
        document.getElementById('google_maps_embed').value = '';
        document.getElementById('apply-location').disabled = true;
        updateMapStatus('empty');
        
        // Clear map preview
        const mapContainer = document.getElementById('location-picker-map');
        mapContainer.innerHTML = `
            <div class="map-placeholder">
                <div class="placeholder-icon">
                    <i class="fas fa-map-marked-alt"></i>
                </div>
                <h4>Ch∆∞a c√≥ b·∫£n ƒë·ªì</h4>
                <p>Paste code iframe v√† nh·∫•n "Xem tr∆∞·ªõc b·∫£n ƒë·ªì" ƒë·ªÉ hi·ªÉn th·ªã</p>
            </div>
        `;
    }
});

// Update map status function
function updateMapStatus(status) {
    const statusDot = document.getElementById('map-status');
    const statusText = document.getElementById('map-status-text');
    
    statusDot.className = 'status-dot';
    
    switch(status) {
        case 'ready':
            statusDot.classList.add('active');
            statusText.textContent = 'S·∫µn s√†ng xem tr∆∞·ªõc';
            break;
        case 'invalid':
            statusDot.classList.add('warning');
            statusText.textContent = 'Code kh√¥ng h·ª£p l·ªá';
            break;
        default:
            statusText.textContent = 'Ch∆∞a c√≥ b·∫£n ƒë·ªì';
    }
}

// Update map status when embed code is added
document.getElementById('google_maps_embed').addEventListener('input', function() {
    const embedCode = this.value.trim();
    
    if (embedCode.length > 0) {
        if (embedCode.includes('<iframe') && embedCode.includes('google.com/maps')) {
            updateMapStatus('ready');
        } else {
            updateMapStatus('invalid');
        }
    } else {
        updateMapStatus('empty');
    }
});

// Address preview functionality
document.getElementById('address_display').addEventListener('input', function() {
    const addressPreview = document.getElementById('address-preview');
    const newAddress = this.value.trim();
    
    if (newAddress) {
        addressPreview.textContent = newAddress;
        // Also update the hidden address field if it exists
        const hiddenAddressField = document.getElementById('address');
        if (hiddenAddressField) {
            hiddenAddressField.value = newAddress;
        }
    } else {
        addressPreview.textContent = '123 ƒê∆∞·ªùng Hoa H∆∞·ªõng D∆∞∆°ng, Qu·∫≠n 1, TP.HCM';
    }
});

// Sync marker title and info fields
document.getElementById('marker_title_display').addEventListener('input', function() {
    const hiddenField = document.getElementById('marker_title');
    if (hiddenField) {
        hiddenField.value = this.value;
    }
});

document.getElementById('marker_info_display').addEventListener('input', function() {
    const hiddenField = document.getElementById('marker_info');
    if (hiddenField) {
        hiddenField.value = this.value;
    }
});
</script>

{% endblock %}
